<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Dorm Inspector</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        [data-theme="light"] {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-light: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--background);
            min-height: 100vh;
            color: var(--text-primary);
            font-size: 16px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0;
        }

        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 24px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s ease;
        }

        .header-title:active {
            transform: scale(0.98);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .header-text h1 {
            font-size: 20px;
            font-weight: 800;
            color: white;
            letter-spacing: -0.5px;
        }

        .header-text p {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .icon-button {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: none;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            font-size: 18px;
        }

        .icon-button:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.3);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: white;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--success);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Navigation */
        .nav-container {
            background: var(--surface);
            border-top: 1px solid var(--border);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 90;
            box-shadow: 0 -4px 20px var(--shadow);
        }

        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            max-width: 1200px;
            margin: 0 auto;
            gap: 0;
        }

        .nav-tab {
            padding: 16px 12px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-tab-icon {
            font-size: 20px;
        }

        .nav-tab::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .nav-tab.active {
            color: var(--primary);
        }

        .nav-tab.active::after {
            transform: scaleX(1);
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px 20px;
            padding-bottom: 120px; /* Extra padding for bottom navigation */
        }
        
        /* Sticky Save Button */
        .sticky-save-container {
            position: fixed;
            bottom: 88px; /* Above the nav tabs */
            left: 0;
            right: 0;
            background: linear-gradient(to top, var(--background) 85%, transparent);
            padding: 12px 16px 8px 16px;
            box-shadow: 0 -4px 20px var(--shadow);
            z-index: 85;
            border-top: 1px solid var(--border);
        }
        
        #save-btn-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        #save-btn-content strong {
            font-weight: 800;
            letter-spacing: 0.5px;
        }
        
        #save-btn:active {
            transform: translateY(2px);
        }
        
        /* Add extra padding to inspect section content to prevent overlap */
        #new-section {
            padding-top: 16px;
            padding-bottom: 65px; /* Reduced to match smaller button area */
        }
        
        @media (max-width: 768px) {
            .sticky-save-container {
                padding: 10px 12px 6px 12px;
            }
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Card Styles */
        .card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 1px 3px var(--shadow);
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }
        
        /* Compact styling for inspect section */
        #new-section .card {
            padding: 16px;
            margin-bottom: 16px;
        }
        
        #new-section .card-header {
            margin-bottom: 14px;
        }
        
        #new-section .form-grid {
            gap: 14px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        
        #new-section .card-header {
            margin-bottom: 14px;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }
        
        #new-section .card-icon {
            width: 36px;
            height: 36px;
            font-size: 18px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }
        
        #new-section .card-title {
            font-size: 16px;
        }

        /* Toggle Switch */
        .toggle-card {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            margin-bottom: 16px;
            padding: 16px;
        }
        
        .toggle-card .card-header {
            margin-bottom: 12px;
        }

        .toggle-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }

        .toggle-option {
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-weight: 600;
            font-size: 13px;
        }

        .toggle-option input[type="radio"] {
            width: 20px;
            height: 20px;
            accent-color: white;
        }

        .toggle-option:has(input:checked) {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.02);
        }

        /* Form Elements */
        .form-grid {
            display: grid;
            gap: 16px;
        }
        
        #new-section .form-grid {
            gap: 12px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        /* Compact labels in inspect section */
        #new-section .form-group label {
            margin-bottom: 6px;
            font-size: 13px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 14px 16px;
            background: var(--surface-light);
            border: 2px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 15px;
            font-weight: 500;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        
        /* Compact inputs in inspect section */
        #new-section .form-input,
        #new-section .form-select,
        #new-section .form-textarea {
            padding: 10px 12px;
            font-size: 14px;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        /* Demerit Items */
        .demerits-section {
            margin: 16px 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 2px solid var(--border);
        }
        
        .section-header h3 {
            font-size: 15px;
            font-weight: 700;
        }

        .section-badge {
            padding: 3px 10px;
            background: var(--primary);
            color: white;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
        }

        .section-badge.danger {
            background: var(--error);
        }

        .demerits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 10px;
        }
        
        @media (min-width: 769px) {
            .demerits-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .demerit-item {
            padding: 10px 14px;
            background: var(--surface-light);
            border: 2px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .demerit-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .demerit-item.auto-failure::before {
            background: var(--error);
        }

        .demerit-item:active {
            transform: scale(0.98);
        }

        .demerit-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
            font-size: 12px;
        }

        .demerit-item.checked {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--error);
        }

        .demerit-item.checked::before {
            transform: scaleY(1);
        }

        .demerit-item.checked .demerit-checkbox {
            background: var(--error);
            border-color: var(--error);
        }

        .demerit-item.checked .demerit-checkbox::after {
            content: '‚úì';
            color: white;
            font-weight: 700;
        }

        .demerit-text {
            flex: 1;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 13px;
            line-height: 1.3;
        }

        /* Score Display */
        .score-card {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            margin: 16px 0;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
        }

        .score-card.outstanding {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            box-shadow: 0 8px 24px rgba(59, 130, 246, 0.3);
        }

        .score-card.fail {
            background: linear-gradient(135deg, var(--error), #dc2626);
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
        }

        .score-number {
            font-size: 36px;
            font-weight: 800;
            margin-bottom: 4px;
            letter-spacing: -1px;
        }

        .score-label {
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
        }

        /* Buttons */
        .btn {
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        /* Compact buttons in inspect section */
        #new-section .btn {
            padding: 12px 20px;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .btn-primary:active {
            transform: translateY(2px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: var(--surface-light);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--error), #dc2626);
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #d97706);
            color: white;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Room Tiles */
        .room-tiles-container {
            background: var(--surface-light);
            border-radius: 16px;
            padding: 20px;
            margin: 20px 0;
        }

        .room-tiles-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .room-tiles-controls {
            display: flex;
            gap: 8px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 12px;
            border-radius: 8px;
        }

        .room-tiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding: 8px;
        }

        .room-tile {
            aspect-ratio: 1;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
            position: relative;
            padding: 8px;
        }

        .room-tile:active {
            transform: scale(0.95);
        }

        .room-tile.selected {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
            transform: scale(1.05);
        }

        .room-tile.selected::after {
            content: '‚úì';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 10px;
            background: rgba(255, 255, 255, 0.3);
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .room-number {
            font-size: 15px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .room-badges {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .room-badge {
            padding: 2px 6px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 4px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .room-badge.shift-s {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .room-badge.shift-t {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .room-badge.shift-r {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .room-badge.gender-male {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .room-badge.gender-female {
            background: rgba(236, 72, 153, 0.2);
            color: var(--accent);
        }

        .room-tile.selected .room-badge {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        .room-tile.selected .room-badge.shift-s {
            background: rgba(16, 185, 129, 0.3);
        }

        .room-tile.selected .room-badge.shift-t {
            background: rgba(245, 158, 11, 0.3);
        }

        .room-tile.selected .room-badge.shift-r {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Inspection Cards */
        .inspection-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
            transition: all 0.3s ease;
        }

        .inspection-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .inspection-card.pass {
            border-left: 4px solid var(--success);
        }

        .inspection-card.outstanding {
            border-left: 4px solid #3b82f6;
        }

        .inspection-card.fail {
            border-left: 4px solid var(--error);
        }

        .inspection-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .inspection-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .inspection-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .inspection-badge.pass {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .inspection-badge.outstanding {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .inspection-badge.fail {
            background: rgba(239, 68, 68, 0.2);
            color: var(--error);
        }

        .inspection-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin: 24px 0;
        }

        .stat-card {
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card.highlight {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-color: transparent;
        }

        .stat-card.highlight .stat-number,
        .stat-card.highlight .stat-label {
            color: white;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Admin Panel */
        .admin-panel {
            display: none;
            margin: 24px 0;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-header {
            background: linear-gradient(135deg, var(--error), #dc2626);
            color: white;
            padding: 24px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
        }

        .admin-body {
            background: var(--surface);
            border: 2px solid var(--error);
            border-top: none;
            border-radius: 0 0 16px 16px;
            padding: 24px;
        }

        .admin-section {
            margin-bottom: 24px;
        }

        .admin-section h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .admin-grid {
            display: grid;
            gap: 12px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-text h1 {
                font-size: 16px;
            }

            .header-text p {
                display: none;
            }

            .nav-tabs {
                grid-template-columns: repeat(4, 1fr);
            }

            .nav-tab {
                font-size: 11px;
                padding: 12px 8px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            #tutorial-card {
                max-width: calc(100vw - 40px);
                left: 20px !important;
                right: 20px !important;
            }
        }

        /* Smooth scrolling */
        .room-tiles-grid, .modal-content {
            -webkit-overflow-scrolling: touch;
        }

        /* Dark mode toggle styles */
        .theme-switcher {
            display: flex;
            gap: 8px;
            padding: 16px;
            background: var(--surface-light);
            border-radius: 12px;
        }

        .theme-option {
            flex: 1;
            padding: 12px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .theme-option.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: transparent;
        }

        /* Range Slider Styles */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 8px;
            background: var(--surface-light);
            border-radius: 4px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        input[type="range"]::-webkit-slider-thumb:active {
            transform: scale(0.95);
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.1);
        }

        input[type="range"]::-moz-range-thumb:active {
            transform: scale(0.95);
        }

        .preset-btn {
            transition: all 0.3s ease;
        }

        .preset-btn:active {
            transform: scale(0.95);
        }

        /* Tutorial Styles */
        #tutorial-card {
            animation: tutorialSlideIn 0.4s ease-out;
        }

        @keyframes tutorialSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        #tutorial-spotlight {
            animation: spotlightPulse 2s ease-in-out infinite;
        }

        @keyframes spotlightPulse {
            0%, 100% {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85), 0 0 30px var(--primary);
            }
            50% {
                box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85), 0 0 50px var(--primary), 0 0 80px var(--primary);
            }
        }

        kbd {
            padding: 2px 6px;
            background: var(--surface-light);
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            border: 1px solid var(--border);
        }

        .quick-view-btn:hover {
            opacity: 0.8;
        }

        .quick-view-btn:active {
            transform: scale(0.95);
        }

        /* Live Clock Styles */
        .live-clock-container {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 24px;
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .live-clock-time {
            font-size: 36px;
            font-weight: 800;
            color: white;
            margin-bottom: 8px;
            font-variant-numeric: tabular-nums;
            letter-spacing: 2px;
        }

        .live-clock-date {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .live-clock-seconds {
            font-size: 18px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 4px;
        }
    </style>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 800;">‚öôÔ∏è Settings</h2>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Customize your experience</p>
                </div>
                <button onclick="closeSettings()" class="icon-button" style="background: var(--surface-light);">√ó</button>
            </div>

            <!-- Live Clock Section -->
            <div class="live-clock-container">
                <div class="live-clock-time" id="live-clock-time">--:--:--</div>
                <div class="live-clock-date" id="live-clock-date">Loading...</div>
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 12px;">Theme Mode</label>
                <div class="theme-switcher">
                    <div class="theme-option" onclick="setTheme('dark')" id="theme-dark">üåô Dark</div>
                    <div class="theme-option" onclick="setTheme('light')" id="theme-light">‚òÄÔ∏è Light</div>
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 12px;">Color Scheme</label>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px;">
                    <button onclick="applyPreset('default')" class="preset-btn" data-preset="default" style="padding: 8px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: white; font-weight: 600; font-size: 12px;">Default</button>
                    <button onclick="applyPreset('ocean')" class="preset-btn" data-preset="ocean" style="padding: 8px; background: linear-gradient(135deg, #0ea5e9, #06b6d4); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: white; font-weight: 600; font-size: 12px;">Ocean</button>
                    <button onclick="applyPreset('sunset')" class="preset-btn" data-preset="sunset" style="padding: 8px; background: linear-gradient(135deg, #f59e0b, #ef4444); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: white; font-weight: 600; font-size: 12px;">Sunset</button>
                    <button onclick="applyPreset('forest')" class="preset-btn" data-preset="forest" style="padding: 8px; background: linear-gradient(135deg, #10b981, #059669); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: white; font-weight: 600; font-size: 12px;">Forest</button>
                    <button onclick="applyPreset('royal')" class="preset-btn" data-preset="royal" style="padding: 8px; background: linear-gradient(135deg, #7c3aed, #a855f7); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: white; font-weight: 600; font-size: 12px;">Royal</button>
                    <button onclick="applyPreset('rose')" class="preset-btn" data-preset="rose" style="padding: 8px; background: linear-gradient(135deg, #ec4899, #f43f5e); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; color: white; font-weight: 600; font-size: 12px;">Rose</button>
                </div>
                <div style="background: var(--surface-light); padding: 16px; border-radius: 12px;">
                    <h4 style="font-size: 13px; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">Custom Colors</h4>
                    <div style="display: grid; gap: 12px;">
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Primary Color</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="color" id="primary-color" value="#6366f1" onchange="updateCustomColor('primary', this.value)" style="width: 50px; height: 36px; border: none; border-radius: 8px; cursor: pointer;">
                                <input type="text" id="primary-color-text" value="#6366f1" onchange="updateCustomColorFromText('primary', this.value)" style="flex: 1; padding: 8px 12px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 12px; color: var(--text-primary);">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Secondary Color</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="color" id="secondary-color" value="#8b5cf6" onchange="updateCustomColor('secondary', this.value)" style="width: 50px; height: 36px; border: none; border-radius: 8px; cursor: pointer;">
                                <input type="text" id="secondary-color-text" value="#8b5cf6" onchange="updateCustomColorFromText('secondary', this.value)" style="flex: 1; padding: 8px 12px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 12px; color: var(--text-primary);">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-size: 12px; font-weight: 600; margin-bottom: 6px; color: var(--text-secondary);">Accent Color</label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <input type="color" id="accent-color" value="#ec4899" onchange="updateCustomColor('accent', this.value)" style="width: 50px; height: 36px; border: none; border-radius: 8px; cursor: pointer;">
                                <input type="text" id="accent-color-text" value="#ec4899" onchange="updateCustomColorFromText('accent', this.value)" style="flex: 1; padding: 8px 12px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; font-family: monospace; font-size: 12px; color: var(--text-primary);">
                            </div>
                        </div>
                    </div>
                    <button onclick="resetColors()" style="width: 100%; margin-top: 12px; padding: 10px; background: var(--surface); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; color: var(--text-primary);">Reset to Defaults</button>
                </div>
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display: flex; justify-content: space-between; align-items: center; font-weight: 600;">
                    Haptic Feedback
                    <div onclick="toggleHaptic()" style="width: 56px; height: 32px; background: var(--border); border-radius: 16px; position: relative; cursor: pointer; transition: all 0.3s ease;" id="haptic-toggle">
                        <div style="position: absolute; top: 4px; left: 4px; width: 24px; height: 24px; background: white; border-radius: 50%; transition: all 0.3s ease;" id="haptic-slider"></div>
                    </div>
                </label>
            </div>

            <div style="margin-bottom: 24px;">
                <label style="display: block; font-weight: 600; margin-bottom: 12px;">Text Size / Zoom Level</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="adjustZoom(-10)" class="btn btn-secondary" style="padding: 8px 16px; font-size: 18px; line-height: 1;">‚àí</button>
                    <div style="flex: 1;">
                        <input type="range" id="zoom-slider" min="70" max="150" step="5" value="100" oninput="setZoom(this.value)" style="width: 100%; cursor: pointer;">
                        <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 11px; color: var(--text-muted);">
                            <span>70%</span>
                            <span id="zoom-value" style="font-weight: 700; color: var(--primary);">100%</span>
                            <span>150%</span>
                        </div>
                    </div>
                    <button onclick="adjustZoom(10)" class="btn btn-secondary" style="padding: 8px 16px; font-size: 18px; line-height: 1;">+</button>
                </div>
                <button onclick="resetZoom()" style="width: 100%; margin-top: 8px; padding: 8px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 13px; color: var(--text-primary);">Reset to 100%</button>
                <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px; text-align: center;">
                    üí° Tip: Use <kbd style="padding: 2px 6px; background: var(--surface-light); border-radius: 4px; font-family: monospace;">Ctrl/Cmd +</kbd> <kbd style="padding: 2px 6px; background: var(--surface-light); border-radius: 4px; font-family: monospace;">‚àí</kbd> <kbd style="padding: 2px 6px; background: var(--surface-light); border-radius: 4px; font-family: monospace;">0</kbd> for quick zoom control
                </p>
            </div>

            <div style="margin-bottom: 24px; padding-top: 24px; border-top: 2px solid var(--border);">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">üìã View Customization</h3>
                
                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">History View Mode</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <button class="view-mode-btn" data-mode="card" onclick="setViewMode('card')" style="padding: 10px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                            <span style="font-size: 18px;">üóá</span>
                            <span>Card</span>
                        </button>
                        <button class="view-mode-btn" data-mode="list" onclick="setViewMode('list')" style="padding: 10px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                            <span style="font-size: 18px;">üìã</span>
                            <span>List</span>
                        </button>
                        <button class="view-mode-btn" data-mode="table" onclick="setViewMode('table')" style="padding: 10px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 12px; transition: all 0.3s; display: flex; flex-direction: column; align-items: center; gap: 4px;">
                            <span style="font-size: 18px;">üìä</span>
                            <span>Table</span>
                        </button>
                    </div>
                    <p style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">
                        Card: Detailed view ‚Ä¢ List: Compact overview ‚Ä¢ Table: Sortable data grid
                    </p>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Display Density</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <button class="density-btn" data-density="compact" onclick="setDensity('compact')" style="padding: 8px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; transition: all 0.3s;">Compact</button>
                        <button class="density-btn" data-density="comfortable" onclick="setDensity('comfortable')" style="padding: 8px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; transition: all 0.3s;">Comfortable</button>
                        <button class="density-btn" data-density="spacious" onclick="setDensity('spacious')" style="padding: 8px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 11px; transition: all 0.3s;">Spacious</button>
                    </div>
                </div>

                <div style="margin-bottom: 16px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Visible Fields</label>
                    <div style="background: var(--surface-light); padding: 12px; border-radius: 8px;">
                        <div style="display: grid; gap: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="field-shift" checked onchange="toggleField('shift')" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                <span>Shift Badge</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="field-gender" checked onchange="toggleField('gender')" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                <span>Gender Badge</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="field-date" checked onchange="toggleField('date')" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                <span>Inspection Date</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="field-inspector" checked onchange="toggleField('inspector')" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                <span>Inspector Name</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="field-score" checked onchange="toggleField('score')" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                <span>Score</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="field-violations" checked onchange="toggleField('violations')" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                <span>Violations List</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer;">
                                <input type="checkbox" id="field-notes" checked onchange="toggleField('notes')" style="width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary);">
                                <span>Notes</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 24px; padding-top: 24px; border-top: 2px solid var(--border);">
                <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 12px; color: var(--text-primary);">üìö Help & Tutorial</h3>
                <button onclick="startTutorial()" class="btn btn-primary" style="width: 100%; margin-bottom: 8px;">
                    üéì Start Interactive Tutorial
                </button>
                <p style="font-size: 11px; color: var(--text-muted); text-align: center;" id="tutorial-status">
                    Learn how to use all features in just a few minutes
                </p>
            </div>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.85); z-index: 3000; backdrop-filter: blur(2px);" onclick="handleTutorialOverlayClick(event)">
        <!-- Tutorial Spotlight -->
        <div id="tutorial-spotlight" style="position: absolute; border: 3px solid var(--primary); border-radius: 12px; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.85), 0 0 30px var(--primary); transition: all 0.5s ease; pointer-events: none;"></div>
        
        <!-- Tutorial Card -->
        <div id="tutorial-card" style="position: fixed; background: var(--surface); border-radius: 20px; padding: 24px; max-width: 400px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); z-index: 3001; border: 2px solid var(--primary);" onclick="event.stopPropagation()">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                <div style="flex: 1;">
                    <div style="display: inline-block; padding: 4px 12px; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border-radius: 20px; font-size: 11px; font-weight: 700; margin-bottom: 8px;" id="tutorial-step-counter">STEP 1 OF 8</div>
                    <h3 id="tutorial-title" style="font-size: 20px; font-weight: 800; color: var(--text-primary); margin-bottom: 8px;">Welcome! üëã</h3>
                </div>
                <button onclick="closeTutorial()" style="background: var(--error); color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">√ó</button>
            </div>
            <p id="tutorial-description" style="color: var(--text-secondary); font-size: 15px; line-height: 1.6; margin-bottom: 20px;">
                Let's take a quick tour of the Dorm Inspector app. This tutorial will show you all the key features.
            </p>
            <div style="display: flex; gap: 8px;">
                <button id="tutorial-prev" onclick="previousTutorialStep()" class="btn btn-secondary" style="flex: 1; display: none;">
                    ‚Üê Previous
                </button>
                <button id="tutorial-skip" onclick="skipTutorial()" class="btn btn-secondary" style="flex: 1;">
                    Skip Tutorial
                </button>
                <button id="tutorial-next" onclick="nextTutorialStep()" class="btn btn-primary" style="flex: 2;">
                    Next ‚Üí
                </button>
            </div>
        </div>
    </div>

    <!-- Room Management Modal -->
    <div class="modal" id="room-management-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <h2 style="font-size: 24px; font-weight: 800;">üè† Manage Room Properties</h2>
                <button onclick="closeRoomManagement()" class="icon-button" style="background: var(--surface-light);">√ó</button>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; font-weight: 600; margin-bottom: 8px;">Select Room</label>
                <select id="room-edit-select" class="form-select" onchange="loadRoomProperties()">
                    <option value="">Choose a room to edit</option>
                </select>
            </div>

            <div id="room-edit-form" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Shift</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                        <button class="shift-btn" data-shift="S" onclick="selectShift('S')" style="padding: 12px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">S</button>
                        <button class="shift-btn" data-shift="T" onclick="selectShift('T')" style="padding: 12px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">T</button>
                        <button class="shift-btn" data-shift="R" onclick="selectShift('R')" style="padding: 12px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">R</button>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <label style="display: block; font-weight: 600; margin-bottom: 8px;">Gender</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                        <button class="gender-btn" data-gender="Male" onclick="selectGender('Male')" style="padding: 12px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">üë® Male</button>
                        <button class="gender-btn" data-gender="Female" onclick="selectGender('Female')" style="padding: 12px; background: var(--surface-light); border: 2px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">üë© Female</button>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveRoomProperties()" style="width: 100%;">üíæ Save Room Properties</button>
            </div>
        </div>
    </div>

    <!-- List Management Modal -->
    <div class="modal" id="list-management-modal">
        <div class="modal-content" style="max-width: 600px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div>
                    <h2 style="font-size: 24px; font-weight: 800;">üìã Manage Inspection Lists</h2>
                    <p style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">Create and organize room lists</p>
                </div>
                <button onclick="closeListManagement()" class="icon-button" style="background: var(--surface-light);">√ó</button>
            </div>

            <div style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="createNewList()" style="width: 100%;">‚ûï Create New List</button>
            </div>

            <div id="lists-container" style="max-height: 400px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- App Container -->
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <div class="header-content">
                <div class="header-title" id="main-title">
                    <div class="logo-icon">üè¢</div>
                    <div class="header-text">
                        <h1>Dorm Inspector</h1>
                        <p>Room Inspection Management</p>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="status-badge">
                        <div class="status-dot" id="status-dot"></div>
                        <span id="status-text">Offline</span>
                    </div>
                    <button class="icon-button" onclick="openSettings()">‚öôÔ∏è</button>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-container">
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('new')">
                    <span class="nav-tab-icon">üìã</span>
                    <span>Inspect</span>
                </button>
                <button class="nav-tab" onclick="showTab('schedule')">
                    <span class="nav-tab-icon">üìÖ</span>
                    <span>Lists</span>
                </button>
                <button class="nav-tab" onclick="showTab('view')">
                    <span class="nav-tab-icon">üìä</span>
                    <span>History</span>
                </button>
                <button class="nav-tab" onclick="showTab('reports')">
                    <span class="nav-tab-icon">üìà</span>
                    <span>Reports</span>
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div id="error-container"></div>

            <!-- Admin Panel -->
            <div id="admin-panel" class="admin-panel">
                <div class="admin-header">
                    <div>
                        <h3 style="font-size: 20px; font-weight: 800; margin-bottom: 4px;">üîß Admin Panel</h3>
                        <p style="font-size: 13px; opacity: 0.9;">System Management</p>
                    </div>
                    <button class="admin-close" onclick="closeAdminPanel()">√ó</button>
                </div>
                <div class="admin-body">
                    <div class="admin-section">
                        <h4>üè† Room Management</h4>
                        <div class="admin-grid">
                            <button class="btn btn-primary" onclick="openRoomManagement()">‚úèÔ∏è Edit Room Properties</button>
                            <button class="btn btn-warning" onclick="bulkSetRoomProperties()">üîß Bulk Set Properties</button>
                        </div>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                            Configured rooms: <span id="configured-rooms-count">0</span>
                        </p>
                    </div>

                    <div class="admin-section">
                        <h4>üìã Inspection Lists</h4>
                        <div class="admin-grid">
                            <button class="btn btn-primary" onclick="openListManagement()">üìã Manage Lists</button>
                            <button class="btn btn-secondary" onclick="createNewList()">‚ûï New List</button>
                        </div>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                            Total lists: <span id="admin-total-lists">0</span> | Active: <span id="admin-active-list">None</span>
                        </p>
                    </div>

                    <div class="admin-section">
                        <h4>üìä Statistics</h4>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="admin-total-inspections">0</div>
                                <div class="stat-label">Inspections</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="admin-scheduled-rooms">0</div>
                                <div class="stat-label">In Lists</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="admin-connection-status">‚óè</div>
                                <div class="stat-label">Database</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="admin-data-size">0KB</div>
                                <div class="stat-label">Data Size</div>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h4>üóÑÔ∏è Data Management</h4>
                        <div class="admin-grid">
                            <button class="btn btn-primary" onclick="forceDataSync()">üîÑ Sync Firebase</button>
                            <button class="btn btn-warning" onclick="exportAllData()">üì• Export JSON</button>
                            <button class="btn btn-warning" onclick="importDataPrompt()">üì§ Import Data</button>
                            <button class="btn btn-danger" onclick="resetAllData()">‚ö†Ô∏è Reset All</button>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h4>üë• Inspectors</h4>
                        <div class="admin-grid">
                            <button class="btn btn-primary" onclick="manageInspectors()">‚úèÔ∏è Edit Names</button>
                            <button class="btn btn-secondary" onclick="resetInspectorNames()">üîÑ Reset Names</button>
                        </div>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px;">
                            <span id="current-inspectors"></span>
                        </p>
                    </div>

                    <div class="admin-section">
                        <h4>üìà Analytics</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px;">
                            <div>
                                <label style="display: block; font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--text-secondary);">Start Date</label>
                                <input type="date" id="analytics-start-date" class="form-input" style="padding: 8px; font-size: 12px;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 11px; font-weight: 600; margin-bottom: 4px; color: var(--text-secondary);">End Date</label>
                                <input type="date" id="analytics-end-date" class="form-input" style="padding: 8px; font-size: 12px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 12px;">
                            <button class="btn btn-secondary btn-small" onclick="setAnalyticsDateRange('week')" style="font-size: 10px; padding: 6px;">7 Days</button>
                            <button class="btn btn-secondary btn-small" onclick="setAnalyticsDateRange('month')" style="font-size: 10px; padding: 6px;">30 Days</button>
                            <button class="btn btn-secondary btn-small" onclick="setAnalyticsDateRange('all')" style="font-size: 10px; padding: 6px;">All Time</button>
                        </div>
                        <div class="admin-grid">
                            <button class="btn btn-primary" onclick="generateInspectorAnalytics()">üë• Performance</button>
                            <button class="btn btn-primary" onclick="generateDemeritTrends()">üìä Violations</button>
                            <button class="btn btn-primary" onclick="generateTimelineReport()">üìÖ Timeline</button>
                        </div>
                        <div id="analytics-display" style="display: none; margin-top: 16px; padding: 16px; background: var(--surface-light); border-radius: 12px; position: relative;">
                            <button onclick="closeAnalytics()" style="position: absolute; top: 12px; right: 12px; background: var(--error); color: white; border: none; width: 28px; height: 28px; border-radius: 6px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center;">√ó</button>
                            <div id="analytics-content"></div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h4>üîß Tools</h4>
                        <div class="admin-grid">
                            <button class="btn btn-secondary" onclick="clearLocalStorage()">üíæ Clear Storage</button>
                            <button class="btn btn-primary" onclick="testFirebasePermissions()">üîç Test Permissions</button>
                            <button class="btn btn-warning" onclick="generateTestData()">üß™ Test Data</button>
                        </div>
                        <p id="last-sync-time" style="font-size: 11px; color: var(--text-muted); margin-top: 12px; text-align: center;">
                            Last synced: Never
                        </p>
                        <div id="admin-log" style="margin-top: 16px; padding: 12px; background: var(--background); border-radius: 8px; font-family: 'Courier New', monospace; font-size: 11px; color: var(--text-muted); max-height: 120px; overflow-y: auto;">
                            Admin panel initialized...<br>
                        </div>
                    </div>
                </div>
            </div>

            <!-- New Inspection Section -->
            <div id="new-section" class="section active">
                <div class="card toggle-card">
                    <div class="card-header">
                        <span style="font-size: 18px; font-weight: 700;">Room Selection Mode</span>
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Inspect from List:</label>
                        <select id="inspection-list-select" class="form-select" onchange="changeInspectionList()">
                            <option value="">All Rooms from All Lists</option>
                        </select>
                    </div>
                    <div class="toggle-options">
                        <label class="toggle-option">
                            <input type="radio" name="roomMode" value="scheduled" checked onchange="toggleRoomMode()">
                            <span>üìÖ From List</span>
                        </label>
                        <label class="toggle-option">
                            <input type="radio" name="roomMode" value="all" onchange="toggleRoomMode()">
                            <span>üè¢ All Rooms</span>
                        </label>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üìã</div>
                        <h2 class="card-title" id="form-title">New Inspection</h2>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label for="roomNumber">Room Number *</label>
                            <select id="roomNumber" class="form-select" required>
                                <option value="">Select Room Number</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="inspectorName">Inspector Name (optional)</label>
                            <select id="inspectorName" class="form-select">
                                <option value="">Select Inspector</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="demerits-section">
                    <div class="section-header">
                        <h3 style="font-size: 15px; font-weight: 700; flex: 1;">Regular Violations</h3>
                        <span class="section-badge">1 Point Each</span>
                    </div>
                    <div class="demerits-grid" id="demerits-container"></div>
                </div>

                <div class="demerits-section">
                    <div class="section-header">
                        <h3 style="font-size: 15px; font-weight: 700; flex: 1;">‚ö†Ô∏è Auto-Failure Violations</h3>
                        <span class="section-badge danger">4 Points Each</span>
                    </div>
                    <div class="demerits-grid" id="auto-failure-container"></div>
                </div>

                <div class="score-card" id="score-display">
                    <div class="score-number">0</div>
                    <div class="score-label">PASSED</div>
                </div>

                <div class="card">
                    <div class="form-group">
                        <label for="notes">Additional Notes</label>
                        <textarea id="notes" class="form-textarea" rows="2" placeholder="Any observations..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Sticky Save Button Container -->
            <div class="sticky-save-container" id="sticky-save-container">
                <div style="max-width: 1200px; margin: 0 auto;">
                    <button class="btn btn-primary" onclick="saveInspection()" id="save-btn" style="width: 100%;">
                        <span id="save-btn-content">üíæ Save Inspection</span>
                    </button>
                    <button class="btn btn-secondary" id="cancel-btn" onclick="cancelEdit()" style="width: 100%; margin-top: 8px; display: none;">
                        Cancel Edit
                    </button>
                </div>
            </div>

            <!-- Schedule Section -->
            <div id="schedule-section" class="section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üìã</div>
                        <h2 class="card-title">Inspection Lists</h2>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-primary" onclick="openListManagement()" style="width: 100%;">
                            üìã Manage Lists
                        </button>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; margin-bottom: 8px;">Active List:</label>
                        <select id="active-list-select" class="form-select" onchange="switchActiveList()">
                            <option value="">No list selected</option>
                        </select>
                        <p style="font-size: 12px; color: var(--text-muted); margin-top: 8px;" id="active-list-info">Select a list to work with</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üè†</div>
                        <h2 class="card-title">Add Rooms to List</h2>
                    </div>

                    <div style="margin-bottom: 20px;">
                        <button class="btn btn-secondary" onclick="openRoomManagement()" style="width: 100%;">
                            üè† Manage Room Properties (Shift & Gender)
                        </button>
                    </div>

                    <div style="margin-bottom: 16px; padding: 12px; background: var(--surface-light); border-radius: 12px;">
                        <div style="font-size: 12px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">Shift Color Key:</div>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="padding: 4px 8px; background: rgba(16, 185, 129, 0.2); color: #10b981; border-radius: 6px; font-size: 11px; font-weight: 700;">S</span>
                                <span style="font-size: 11px; color: var(--text-muted);">S-Shift</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="padding: 4px 8px; background: rgba(245, 158, 11, 0.2); color: #f59e0b; border-radius: 6px; font-size: 11px; font-weight: 700;">T</span>
                                <span style="font-size: 11px; color: var(--text-muted);">T-Shift</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="padding: 4px 8px; background: rgba(239, 68, 68, 0.2); color: #ef4444; border-radius: 6px; font-size: 11px; font-weight: 700;">R</span>
                                <span style="font-size: 11px; color: var(--text-muted);">R-Shift</span>
                            </div>
                        </div>
                    </div>

                    <div class="room-tiles-container">
                        <div class="room-tiles-header">
                            <label style="font-weight: 600;">Select Rooms:</label>
                            <div class="room-tiles-controls">
                                <button class="btn btn-success btn-small" onclick="selectAllRooms()">Select All</button>
                                <button class="btn btn-danger btn-small" onclick="clearAllSelectedRooms()">Clear</button>
                            </div>
                        </div>
                        <div class="room-tiles-grid" id="room-tiles-grid"></div>
                    </div>

                    <button class="btn btn-primary" onclick="addSelectedRoomsToActiveList()" style="width: 100%;">
                        ‚ûï Add to Active List
                    </button>
                </div>

                <div class="card">
                    <h3 style="font-size: 16px; font-weight: 700; margin-bottom: 16px;">Rooms in Active List</h3>
                    <div id="scheduled-rooms" style="min-height: 100px;"></div>
                </div>

                <div style="display: grid; gap: 12px;">
                    <button class="btn btn-danger" onclick="clearActiveList()">üóëÔ∏è Clear Active List</button>
                    <button class="btn btn-primary" onclick="saveSchedule()">üíæ Save Changes</button>
                </div>
            </div>

            <!-- View Section -->
            <div id="view-section" class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 12px;">
                    <h2 style="font-size: 24px; font-weight: 800;">Recent Inspections</h2>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <div style="display: flex; gap: 4px; background: var(--surface-light); padding: 4px; border-radius: 8px;">
                            <button onclick="setViewMode('card')" class="quick-view-btn" data-mode="card" style="padding: 6px 12px; background: transparent; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.2s;" title="Card View">üóá</button>
                            <button onclick="setViewMode('list')" class="quick-view-btn" data-mode="list" style="padding: 6px 12px; background: transparent; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.2s;" title="List View">üìã</button>
                            <button onclick="setViewMode('table')" class="quick-view-btn" data-mode="table" style="padding: 6px 12px; background: transparent; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; transition: all 0.2s;" title="Table View">üìä</button>
                        </div>
                        <button class="btn btn-danger btn-small" onclick="deleteAllInspections()">üóëÔ∏è Delete All</button>
                    </div>
                </div>
                <div id="inspections-list"></div>
            </div>

            <!-- Reports Section -->
            <div id="reports-section" class="section">
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üìà</div>
                        <h2 class="card-title">Inspection Report</h2>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label for="report-start-date">Start Date</label>
                            <input type="date" id="report-start-date" class="form-input" onchange="generateReport()">
                        </div>
                        <div class="form-group">
                            <label for="report-end-date">End Date</label>
                            <input type="date" id="report-end-date" class="form-input" onchange="generateReport()">
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                        <button class="btn btn-secondary btn-small" onclick="setReportDateRange('week')">Last 7 Days</button>
                        <button class="btn btn-secondary btn-small" onclick="setReportDateRange('month')">Last 30 Days</button>
                        <button class="btn btn-secondary btn-small" onclick="setReportDateRange('all')">All Time</button>
                    </div>
                    <div id="report-content"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCEzhO5BhgZrlLnnlfJoQ-jOnpHaa6hfHI",
            authDomain: "dorm-inspection-system.firebaseapp.com",
            projectId: "dorm-inspection-system",
            storageBucket: "dorm-inspection-system.firebasestorage.app",
            messagingSenderId: "996691705980",
            appId: "1:996691705980:web:5c93d55fa107baf14dc9f9",
            measurementId: "G-CJ8QZSEQ36"
        };

        // Settings
        let settings = {
            theme: 'dark',
            hapticFeedback: true,
            zoomLevel: 100,
            customColors: {
                primary: '#6366f1',
                secondary: '#8b5cf6',
                accent: '#ec4899'
            },
            activePreset: 'default',
            tutorialCompleted: false,
            viewMode: 'card',
            density: 'comfortable',
            showFields: {
                roomNumber: true,
                shift: true,
                gender: true,
                date: true,
                inspector: true,
                score: true,
                violations: true,
                notes: true
            }
        };

        // Tutorial state
        let currentTutorialStep = 0;
        const tutorialSteps = [
            {
                title: "Welcome! üëã",
                description: "Let's take a quick tour of the Dorm Inspector app. This tutorial will show you all the key features in just a few minutes.",
                target: null,
                position: "center"
            },
            {
                title: "Navigation Tabs üì±",
                description: "These four tabs let you switch between different sections: Inspect (create new inspections), Lists (manage room lists), History (view past inspections), and Reports (analyze data).",
                target: ".nav-tabs",
                position: "bottom"
            },
            {
                title: "Creating an Inspection üìã",
                description: "Start by selecting a room number. You can choose to inspect from your scheduled list or select from all rooms. Then pick your name from the inspector dropdown.",
                target: "#roomNumber",
                position: "bottom"
            },
            {
                title: "Marking Violations ‚ö†Ô∏è",
                description: "Tap any violation to mark it. Regular violations are worth 1 point each. Auto-failure violations (in red) are worth 4 points each. The score updates automatically as you select violations.",
                target: ".demerits-grid",
                position: "top"
            },
            {
                title: "Score Display üéØ",
                description: "This shows the total score and pass/fail status. Outstanding = 0 points, Pass = 1-3 points, Fail = 4+ points. The color changes based on the status.",
                target: "#score-display",
                position: "top"
            },
            {
                title: "Managing Room Lists üìÖ",
                description: "In the Lists tab, you can create custom inspection lists for different purposes. Select rooms using the grid, then add them to your active list. This helps organize your inspections by week, shift, floor, or any other grouping you need.",
                target: ".nav-tabs",
                position: "bottom",
                changeTab: "schedule"
            },
            {
                title: "Viewing History üìä",
                description: "The History tab shows all past inspections. You can switch between Card, List, and Table views using the buttons at the top. Edit or delete any inspection, and use the date filters in Reports to analyze specific time periods. Customize what information is displayed in Settings.",
                target: ".nav-tabs",
                position: "bottom",
                changeTab: "view"
            },
            {
                title: "All Done! ‚úÖ",
                description: "You're ready to start inspecting! Pro tip: Click the app title 5 times quickly to access the admin panel with advanced features. You can restart this tutorial anytime from Settings.",
                target: null,
                position: "center"
            }
        ];

        const colorPresets = {
            default: { primary: '#6366f1', secondary: '#8b5cf6', accent: '#ec4899' },
            ocean: { primary: '#0ea5e9', secondary: '#06b6d4', accent: '#3b82f6' },
            sunset: { primary: '#f59e0b', secondary: '#ef4444', accent: '#fb923c' },
            forest: { primary: '#10b981', secondary: '#059669', accent: '#34d399' },
            royal: { primary: '#7c3aed', secondary: '#a855f7', accent: '#c084fc' },
            rose: { primary: '#ec4899', secondary: '#f43f5e', accent: '#fb7185' }
        };

        // Live Clock Update
        let clockInterval = null;

        function updateLiveClock() {
            const now = new Date();
            
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeString = `${hours}:${minutes}:${seconds}`;
            
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const dateString = now.toLocaleDateString('en-US', options);
            
            const timeElement = document.getElementById('live-clock-time');
            const dateElement = document.getElementById('live-clock-date');
            
            if (timeElement) timeElement.textContent = timeString;
            if (dateElement) dateElement.textContent = dateString;
        }

        function startLiveClock() {
            updateLiveClock();
            if (clockInterval) clearInterval(clockInterval);
            clockInterval = setInterval(updateLiveClock, 1000);
        }

        function stopLiveClock() {
            if (clockInterval) {
                clearInterval(clockInterval);
                clockInterval = null;
            }
        }

        function loadSettings() {
            const saved = localStorage.getItem('inspectorSettings');
            if (saved) {
                const parsedSettings = JSON.parse(saved);
                settings = {
                    theme: parsedSettings.theme || 'dark',
                    hapticFeedback: parsedSettings.hapticFeedback !== undefined ? parsedSettings.hapticFeedback : true,
                    zoomLevel: parsedSettings.zoomLevel || 100,
                    customColors: parsedSettings.customColors || {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        accent: '#ec4899'
                    },
                    activePreset: parsedSettings.activePreset || 'default',
                    tutorialCompleted: parsedSettings.tutorialCompleted || false,
                    viewMode: parsedSettings.viewMode || 'card',
                    density: parsedSettings.density || 'comfortable',
                    showFields: parsedSettings.showFields || {
                        roomNumber: true,
                        shift: true,
                        gender: true,
                        date: true,
                        inspector: true,
                        score: true,
                        violations: true,
                        notes: true
                    }
                };
            }
            applySettings();
        }

        function saveSettings() {
            localStorage.setItem('inspectorSettings', JSON.stringify(settings));
        }

        function applySettings() {
            document.body.setAttribute('data-theme', settings.theme);
            updateHapticToggle();
            updateThemeButtons();
            applyCustomColors(settings.customColors);
            updateColorInputs();
            updatePresetButtons();
            applyZoom(settings.zoomLevel);
            updateViewModeButtons();
            updateDensityButtons();
            updateFieldCheckboxes();
        }

        function applyCustomColors(colors) {
            const root = document.documentElement;
            root.style.setProperty('--primary', colors.primary);
            root.style.setProperty('--primary-dark', adjustColor(colors.primary, -20));
            root.style.setProperty('--primary-light', adjustColor(colors.primary, 20));
            root.style.setProperty('--secondary', colors.secondary);
            root.style.setProperty('--accent', colors.accent);
        }

        function adjustColor(hex, percent) {
            const num = parseInt(hex.replace('#', ''), 16);
            const amt = Math.round(2.55 * percent);
            const R = Math.max(0, Math.min(255, (num >> 16) + amt));
            const G = Math.max(0, Math.min(255, (num >> 8 & 0x00FF) + amt));
            const B = Math.max(0, Math.min(255, (num & 0x0000FF) + amt));
            return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
        }

        function updateColorInputs() {
            document.getElementById('primary-color').value = settings.customColors.primary;
            document.getElementById('primary-color-text').value = settings.customColors.primary;
            document.getElementById('secondary-color').value = settings.customColors.secondary;
            document.getElementById('secondary-color-text').value = settings.customColors.secondary;
            document.getElementById('accent-color').value = settings.customColors.accent;
            document.getElementById('accent-color-text').value = settings.customColors.accent;
        }

        function updatePresetButtons() {
            document.querySelectorAll('.preset-btn').forEach(btn => {
                const preset = btn.getAttribute('data-preset');
                if (preset === settings.activePreset) {
                    btn.style.border = '2px solid white';
                    btn.style.boxShadow = '0 0 0 2px var(--primary)';
                } else {
                    btn.style.border = '2px solid var(--border)';
                    btn.style.boxShadow = 'none';
                }
            });
        }

        function applyPreset(presetName) {
            const colors = colorPresets[presetName];
            if (colors) {
                settings.customColors = { ...colors };
                settings.activePreset = presetName;
                applyCustomColors(colors);
                updateColorInputs();
                updatePresetButtons();
                saveSettings();
            }
        }

        function updateCustomColor(type, value) {
            settings.customColors[type] = value;
            settings.activePreset = 'custom';
            applyCustomColors(settings.customColors);
            document.getElementById(`${type}-color-text`).value = value;
            updatePresetButtons();
            saveSettings();
        }

        function updateCustomColorFromText(type, value) {
            if (/^#[0-9A-F]{6}$/i.test(value)) {
                settings.customColors[type] = value;
                settings.activePreset = 'custom';
                applyCustomColors(settings.customColors);
                document.getElementById(`${type}-color`).value = value;
                updatePresetButtons();
                saveSettings();
            }
        }

        function resetColors() {
            applyPreset('default');
        }

        function updateThemeButtons() {
            document.querySelectorAll('.theme-option').forEach(el => {
                el.classList.remove('active');
            });
            const activeTheme = document.getElementById('theme-' + settings.theme);
            if (activeTheme) {
                activeTheme.classList.add('active');
            }
        }

        function openSettings() {
            document.getElementById('settings-modal').classList.add('show');
            applyZoom(settings.zoomLevel);
            updateViewModeButtons();
            updateDensityButtons();
            updateFieldCheckboxes();
            
            startLiveClock();
            
            const tutorialStatus = document.getElementById('tutorial-status');
            if (settings.tutorialCompleted) {
                tutorialStatus.innerHTML = '‚úì Tutorial completed ‚Ä¢ <span style="color: var(--primary); cursor: pointer;" onclick="startTutorial()">Restart tutorial</span>';
            } else {
                tutorialStatus.textContent = 'Learn how to use all features in just a few minutes';
            }
        }

        function closeSettings() {
            document.getElementById('settings-modal').classList.remove('show');
            stopLiveClock();
            saveSettings();
        }

        function setTheme(theme) {
            settings.theme = theme;
            applySettings();
        }

        function toggleHaptic() {
            settings.hapticFeedback = !settings.hapticFeedback;
            updateHapticToggle();
            if (settings.hapticFeedback && 'vibrate' in navigator) {
                navigator.vibrate(20);
            }
        }

        function updateHapticToggle() {
            const toggle = document.getElementById('haptic-toggle');
            const slider = document.getElementById('haptic-slider');
            if (settings.hapticFeedback) {
                slider.style.left = '28px';
                toggle.style.background = 'var(--primary)';
            } else {
                slider.style.left = '4px';
                toggle.style.background = 'var(--border)';
            }
        }

        function applyZoom(level) {
            document.body.style.zoom = level + '%';
            const slider = document.getElementById('zoom-slider');
            const valueDisplay = document.getElementById('zoom-value');
            if (slider) slider.value = level;
            if (valueDisplay) valueDisplay.textContent = level + '%';
        }

        function setZoom(level) {
            settings.zoomLevel = parseInt(level);
            applyZoom(level);
            saveSettings();
        }

        function adjustZoom(delta) {
            const newZoom = Math.max(70, Math.min(150, settings.zoomLevel + delta));
            setZoom(newZoom);
        }

        function resetZoom() {
            setZoom(100);
        }

        function setViewMode(mode) {
            settings.viewMode = mode;
            updateViewModeButtons();
            updateQuickViewButtons();
            saveSettings();
            if (document.querySelector('#view-section.active')) {
                loadInspectionsList();
            }
        }

        function updateViewModeButtons() {
            document.querySelectorAll('.view-mode-btn').forEach(btn => {
                const btnMode = btn.getAttribute('data-mode');
                if (btnMode === settings.viewMode) {
                    btn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'transparent';
                } else {
                    btn.style.background = 'var(--surface-light)';
                    btn.style.color = 'var(--text-primary)';
                    btn.style.borderColor = 'var(--border)';
                }
            });
        }

        function updateQuickViewButtons() {
            document.querySelectorAll('.quick-view-btn').forEach(btn => {
                const btnMode = btn.getAttribute('data-mode');
                if (btnMode === settings.viewMode) {
                    btn.style.background = 'var(--primary)';
                    btn.style.color = 'white';
                } else {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-primary)';
                }
            });
        }

        function setDensity(density) {
            settings.density = density;
            updateDensityButtons();
            saveSettings();
            if (document.querySelector('#view-section.active')) {
                loadInspectionsList();
            }
        }

        function updateDensityButtons() {
            document.querySelectorAll('.density-btn').forEach(btn => {
                const btnDensity = btn.getAttribute('data-density');
                if (btnDensity === settings.density) {
                    btn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'transparent';
                } else {
                    btn.style.background = 'var(--surface-light)';
                    btn.style.color = 'var(--text-primary)';
                    btn.style.borderColor = 'var(--border)';
                }
            });
        }

        function toggleField(field) {
            settings.showFields[field] = !settings.showFields[field];
            saveSettings();
            if (document.querySelector('#view-section.active')) {
                loadInspectionsList();
            }
        }

        function updateFieldCheckboxes() {
            Object.keys(settings.showFields).forEach(field => {
                const checkbox = document.getElementById(`field-${field}`);
                if (checkbox) {
                    checkbox.checked = settings.showFields[field];
                }
            });
        }

        // Tutorial Functions
        function startTutorial() {
            closeSettings();
            currentTutorialStep = 0;
            document.getElementById('tutorial-overlay').style.display = 'block';
            showTutorialStep(0);
        }

        function showTutorialStep(stepIndex) {
            const step = tutorialSteps[stepIndex];
            const overlay = document.getElementById('tutorial-overlay');
            const card = document.getElementById('tutorial-card');
            const spotlight = document.getElementById('tutorial-spotlight');
            
            document.getElementById('tutorial-step-counter').textContent = `STEP ${stepIndex + 1} OF ${tutorialSteps.length}`;
            document.getElementById('tutorial-title').textContent = step.title;
            document.getElementById('tutorial-description').textContent = step.description;
            
            document.getElementById('tutorial-prev').style.display = stepIndex > 0 ? 'block' : 'none';
            document.getElementById('tutorial-next').textContent = stepIndex === tutorialSteps.length - 1 ? 'Finish ‚úì' : 'Next ‚Üí';
            document.getElementById('tutorial-skip').style.display = stepIndex === tutorialSteps.length - 1 ? 'none' : 'block';
            
            if (step.changeTab) {
                showTab(step.changeTab);
                setTimeout(() => positionTutorialElements(step, card, spotlight), 300);
            } else {
                positionTutorialElements(step, card, spotlight);
            }
        }

        function positionTutorialElements(step, card, spotlight) {
            if (step.target) {
                const targetElement = document.querySelector(step.target);
                if (targetElement) {
                    const rect = targetElement.getBoundingClientRect();
                    
                    spotlight.style.display = 'block';
                    spotlight.style.top = (rect.top - 8) + 'px';
                    spotlight.style.left = (rect.left - 8) + 'px';
                    spotlight.style.width = (rect.width + 16) + 'px';
                    spotlight.style.height = (rect.height + 16) + 'px';
                    
                    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                    const cardRect = card.getBoundingClientRect();
                    let cardTop, cardLeft;
                    
                    if (step.position === 'bottom') {
                        cardTop = rect.bottom + 20;
                        cardLeft = rect.left + (rect.width / 2) - (cardRect.width / 2);
                    } else if (step.position === 'top') {
                        cardTop = rect.top - cardRect.height - 20;
                        cardLeft = rect.left + (rect.width / 2) - (cardRect.width / 2);
                    } else {
                        cardTop = rect.top + (rect.height / 2) - (cardRect.height / 2);
                        cardLeft = rect.right + 20;
                    }
                    
                    cardTop = Math.max(20, Math.min(cardTop, window.innerHeight - cardRect.height - 20));
                    cardLeft = Math.max(20, Math.min(cardLeft, window.innerWidth - cardRect.width - 20));
                    
                    card.style.top = cardTop + 'px';
                    card.style.left = cardLeft + 'px';
                }
            } else {
                spotlight.style.display = 'none';
                card.style.top = '50%';
                card.style.left = '50%';
                card.style.transform = 'translate(-50%, -50%)';
            }
        }

        function nextTutorialStep() {
            if (currentTutorialStep < tutorialSteps.length - 1) {
                currentTutorialStep++;
                showTutorialStep(currentTutorialStep);
            } else {
                completeTutorial();
            }
        }

        function previousTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                showTutorialStep(currentTutorialStep);
            }
        }

        function skipTutorial() {
            if (confirm('Are you sure you want to skip the tutorial? You can restart it anytime from Settings.')) {
                closeTutorial();
            }
        }

        function completeTutorial() {
            settings.tutorialCompleted = true;
            saveSettings();
            closeTutorial();
            
            const scoreDisplay = document.getElementById('score-display');
            const originalHTML = scoreDisplay.innerHTML;
            const originalClass = scoreDisplay.className;
            
            scoreDisplay.className = 'score-card outstanding';
            scoreDisplay.innerHTML = `
                <div class="score-number" style="font-size: 32px;">üéì</div>
                <div class="score-label">Tutorial Complete!</div>
            `;
            
            setTimeout(() => {
                scoreDisplay.innerHTML = originalHTML;
                scoreDisplay.className = originalClass;
            }, 3000);
            
            showTab('new');
        }

        function closeTutorial() {
            document.getElementById('tutorial-overlay').style.display = 'none';
            document.getElementById('tutorial-card').style.transform = '';
        }

        function handleTutorialOverlayClick(event) {
            if (event.target.id === 'tutorial-overlay') {
                skipTutorial();
            }
        }

        function checkFirstTimeUser() {
            if (!settings.tutorialCompleted && inspections.length === 0) {
                setTimeout(() => {
                    if (confirm('Welcome to Dorm Inspector! Would you like to take a quick tutorial to learn how to use the app?')) {
                        startTutorial();
                    }
                }, 1000);
            }
        }

        // Initialize Firebase
        let db;
        let isConnected = false;

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            console.log('‚úì Firebase initialized successfully');
            console.log('‚úì Firestore connection established');
            updateConnectionStatus(true);
        } catch (error) {
            console.error('‚úó Firebase initialization failed:', error);
            console.error('Error details:', error.message);
            updateConnectionStatus(false);
        }

        // Global variables
        var inspections = [];
        var editingId = null;
        var scheduledRooms = [];
        var isLoading = false;
        var selectedRoomTiles = new Set();
        var titleClickCount = 0;
        var titleClickTimer = null;
        var inspectorNames = ['Hoskins', 'Troope', 'Smith', 'Cherry', 'Avila', 'Young', 'Grier'];
        var roomProperties = {};
        var inspectionLists = [];
        var activeListId = null;

        var demerits = [
            "Bed not made or missing 341",
            "Mirror",
            "Vanity/Sink",
            "Dirty tile or Carpet",
            "Foul odor",
            "High dust or excessive clutter",
            "Trash",
            "Fridge, freezer, or microwave",
            "Shower curtain",
            "Bathtub/shower",
            "Excessive mold build-up",
            "Toilet",
            "Dirty bathroom tile, rugs, or towels"
        ];

        var autoFailureDemerits = [
            "HAZMAT",
            "Unsecured wall locker or keys",
            "Unsecured valuables or uniforms",
            "Unsecured prescription medications",
            "Unsecured Tobacco",
            "Unsecured perishable food",
            "Contraband",
            "Safety items/open window",
            "To-go container/pizza box"
        ];

        function updateConnectionStatus(connected, statusMessage = null) {
            isConnected = connected;
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');

            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = statusMessage || 'Online';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = statusMessage || 'Offline';
            }
        }

        function showError(message) {
            const container = document.getElementById('error-container');
            container.innerHTML = `
                <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--error); padding: 16px; border-radius: 12px; margin-bottom: 20px; color: var(--text-primary);">
                    <strong>Error:</strong> ${message}
                </div>
            `;
            setTimeout(() => container.innerHTML = '', 5000);
        }

        function showLoading(show) {
            isLoading = show;
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.toggle('show', show);
        }

        async function loadData() {
            if (!isConnected) {
                loadLocalData();
                return;
            }

            try {
                showLoading(true);
                const inspectionsDoc = await db.collection('dormData').doc('inspections').get();
                if (inspectionsDoc.exists) {
                    inspections = inspectionsDoc.data().inspections || [];
                } else {
                    // Initialize with empty data if document doesn't exist
                    inspections = [];
                    console.log('Inspections document does not exist, initializing empty array');
                }

                const scheduleDoc = await db.collection('dormData').doc('schedule').get();
                if (scheduleDoc.exists) {
                    scheduledRooms = scheduleDoc.data().scheduledRooms || [];
                } else {
                    scheduledRooms = [];
                    console.log('Schedule document does not exist, initializing empty array');
                }

                const inspectorsDoc = await db.collection('dormData').doc('inspectors').get();
                if (inspectorsDoc.exists) {
                    inspectorNames = inspectorsDoc.data().inspectorNames || inspectorNames;
                } else {
                    // Keep default inspector names if document doesn't exist
                    console.log('Inspectors document does not exist, using default names');
                }

                const roomPropsDoc = await db.collection('dormData').doc('roomProperties').get();
                if (roomPropsDoc.exists) {
                    roomProperties = roomPropsDoc.data().roomProperties || {};
                } else {
                    roomProperties = {};
                    console.log('Room properties document does not exist, initializing empty object');
                }

                const listsDoc = await db.collection('dormData').doc('inspectionLists').get();
                if (listsDoc.exists) {
                    inspectionLists = listsDoc.data().inspectionLists || [];
                    activeListId = listsDoc.data().activeListId || null;
                } else {
                    inspectionLists = [];
                    activeListId = null;
                    console.log('Inspection lists document does not exist, initializing empty array');
                }

                console.log('Data loaded from Firebase successfully');
                console.log('Inspections:', inspections.length, 'Inspector Names:', inspectorNames.length, 'Lists:', inspectionLists.length);
                
                // If no data exists in Firebase, try to initialize from localStorage
                if (inspections.length === 0 && inspectionLists.length === 0) {
                    console.log('No data in Firebase, attempting to load from localStorage...');
                    loadLocalData();
                    // Save to Firebase if localStorage had data
                    if (inspections.length > 0 || inspectionLists.length > 0) {
                        console.log('Migrating data from localStorage to Firebase...');
                        await saveData();
                    }
                }
            } catch (error) {
                console.error('Error loading from Firebase:', error);
                loadLocalData();
            } finally {
                showLoading(false);
            }
        }

        function loadLocalData() {
            try {
                inspections = JSON.parse(localStorage.getItem('dormInspections') || '[]');
                scheduledRooms = JSON.parse(localStorage.getItem('weeklySchedule') || '[]');
                inspectorNames = JSON.parse(localStorage.getItem('inspectorNames') || '[]') || inspectorNames;
                roomProperties = JSON.parse(localStorage.getItem('roomProperties') || '{}');
                inspectionLists = JSON.parse(localStorage.getItem('inspectionLists') || '[]');
                activeListId = localStorage.getItem('activeListId') || null;
            } catch (e) {
                console.error('Error loading local data:', e);
            }
        }

        async function saveData() {
            // Always save to localStorage first
            try {
                localStorage.setItem('dormInspections', JSON.stringify(inspections));
                localStorage.setItem('weeklySchedule', JSON.stringify(scheduledRooms));
                localStorage.setItem('inspectorNames', JSON.stringify(inspectorNames));
                localStorage.setItem('roomProperties', JSON.stringify(roomProperties));
                localStorage.setItem('inspectionLists', JSON.stringify(inspectionLists));
                localStorage.setItem('activeListId', activeListId || '');
                console.log('‚úì Data saved to localStorage');
            } catch (error) {
                console.error('‚úó Failed to save to localStorage:', error);
            }

            // Try to save to Firebase
            if (isConnected && db) {
                try {
                    console.log('üì§ Attempting to save to Firebase...');
                    
                    await db.collection('dormData').doc('inspections').set({
                        inspections: inspections,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úì Saved inspections to Firebase');
                    
                    await db.collection('dormData').doc('schedule').set({
                        scheduledRooms: scheduledRooms,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úì Saved schedule to Firebase');
                    
                    await db.collection('dormData').doc('inspectors').set({
                        inspectorNames: inspectorNames,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úì Saved inspectors to Firebase');
                    
                    await db.collection('dormData').doc('roomProperties').set({
                        roomProperties: roomProperties,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úì Saved room properties to Firebase');
                    
                    await db.collection('dormData').doc('inspectionLists').set({
                        inspectionLists: inspectionLists,
                        activeListId: activeListId,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    console.log('‚úì Saved inspection lists to Firebase');
                    
                    console.log('‚úÖ All data successfully saved to Firebase!');
                    updateLastSyncTime();
                    
                } catch (error) {
                    console.error('‚ùå FIREBASE SAVE FAILED:', error);
                    console.error('Error code:', error.code);
                    console.error('Error message:', error.message);
                    
                    // Show user-friendly error message
                    if (error.code === 'permission-denied') {
                        console.error('üö´ PERMISSION DENIED: Check your Firestore security rules!');
                        showFirebaseError('Permission Denied: Check Firestore security rules in Firebase Console');
                    } else {
                        console.error('üö´ ERROR: ' + error.message);
                        showFirebaseError('Failed to sync to Firebase: ' + error.message);
                    }
                    
                    // Update connection status to show there's an issue
                    updateConnectionStatus(false, 'Save Failed');
                }
            } else {
                console.log('‚ö†Ô∏è Not connected to Firebase - data saved locally only');
            }
        }

        function showFirebaseError(message) {
            const container = document.getElementById('error-container');
            if (container) {
                container.innerHTML = `
                    <div style="background: rgba(239, 68, 68, 0.1); border-left: 4px solid var(--error); padding: 16px; border-radius: 12px; margin-bottom: 20px; color: var(--text-primary);">
                        <strong>‚ö†Ô∏è Firebase Sync Error:</strong> ${message}
                        <br><small>Data is saved locally but not syncing to cloud.</small>
                    </div>
                `;
                setTimeout(() => container.innerHTML = '', 8000);
            }
        }

        function updateLastSyncTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            localStorage.setItem('lastSyncTime', now.toISOString());
            
            const syncElement = document.getElementById('last-sync-time');
            if (syncElement) {
                syncElement.textContent = 'Last synced: ' + timeString;
            }
        }

        // Tab Navigation
        function showTab(tab) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));

            const tabMap = { new: 0, schedule: 1, view: 2, reports: 3 };
            const tabs = document.querySelectorAll('.nav-tab');
            tabs[tabMap[tab]].classList.add('active');

            document.getElementById(`${tab}-section`).classList.add('active');
            
            // Show/hide sticky save button based on tab
            const stickySaveContainer = document.getElementById('sticky-save-container');
            if (stickySaveContainer) {
                if (tab === 'new') {
                    stickySaveContainer.style.display = 'block';
                } else {
                    stickySaveContainer.style.display = 'none';
                }
            }

            if (tab === 'new' || tab === 'schedule') setupForm();
            if (tab === 'view') {
                loadInspectionsList();
                updateQuickViewButtons();
            }
            if (tab === 'reports') generateReport();
        }

        function toggleRoomMode() {
            updateRoomDropdown(true);
        }

        function setupForm() {
            updateRoomDropdown();
            updateActiveListSelect();
            updateInspectionListSelect();
            setupRoomTiles();
            updateInspectorDropdown();
            setupInspectorNamePersistence();
            loadSavedInspectorName();
            updateScheduledRoomsDisplay();
            updateAdminStats();

            const container = document.getElementById('demerits-container');
            container.innerHTML = '';
            demerits.forEach((demerit, index) => {
                const item = document.createElement('div');
                item.className = 'demerit-item';
                item.setAttribute('data-index', index);
                item.setAttribute('data-type', 'regular');
                item.innerHTML = `
                    <div class="demerit-checkbox"></div>
                    <div class="demerit-text">${demerit}</div>
                `;
                item.onclick = function() {
                    this.classList.toggle('checked');
                    updateScore();
                };
                container.appendChild(item);
            });

            const autoContainer = document.getElementById('auto-failure-container');
            autoContainer.innerHTML = '';
            autoFailureDemerits.forEach((demerit, index) => {
                const item = document.createElement('div');
                item.className = 'demerit-item auto-failure';
                item.setAttribute('data-index', index);
                item.setAttribute('data-type', 'auto-failure');
                item.innerHTML = `
                    <div class="demerit-checkbox"></div>
                    <div class="demerit-text">${demerit}</div>
                `;
                item.onclick = function() {
                    this.classList.toggle('checked');
                    updateScore();
                };
                autoContainer.appendChild(item);
            });

            updateScore();
        }

        function setupInspectorNamePersistence() {
            var inspectorSelect = document.getElementById('inspectorName');
            if (inspectorSelect) {
                inspectorSelect.addEventListener('change', function () {
                    saveInspectorName(this.value);
                });
            }
        }

        function loadSavedInspectorName() {
            try {
                var savedName = localStorage.getItem('inspectorName');
                if (savedName) {
                    var inspectorSelect = document.getElementById('inspectorName');
                    if (inspectorSelect) {
                        var optionExists = Array.from(inspectorSelect.options).some(function (option) {
                            return option.value === savedName;
                        });
                        if (optionExists) {
                            inspectorSelect.value = savedName;
                        }
                    }
                }
            } catch (e) {
                console.error('Error loading saved inspector name:', e);
            }
        }

        function saveInspectorName(name) {
            try {
                if (name && name.trim()) {
                    localStorage.setItem('inspectorName', name.trim());
                }
            } catch (e) {
                console.error('Error saving inspector name:', e);
            }
        }

        function updateScore() {
            const regularChecked = document.querySelectorAll('.demerit-item[data-type="regular"].checked').length;
            const autoFailureChecked = document.querySelectorAll('.demerit-item[data-type="auto-failure"].checked').length;
            const totalScore = regularChecked + (autoFailureChecked * 4);
            
            let status, statusClass;
            if (totalScore === 0) {
                status = 'OUTSTANDING';
                statusClass = 'outstanding';
            } else if (totalScore >= 1 && totalScore <= 3) {
                status = 'PASSED';
                statusClass = '';
            } else {
                status = 'FAILED';
                statusClass = 'fail';
            }

            const scoreDisplay = document.getElementById('score-display');
            scoreDisplay.querySelector('.score-number').textContent = totalScore;
            scoreDisplay.querySelector('.score-label').textContent = status;
            scoreDisplay.className = `score-card ${statusClass}`;
            
            // Update save button with room number and status
            updateSaveButton(status, statusClass);
        }
        
        function updateSaveButton(status, statusClass) {
            const saveBtn = document.getElementById('save-btn');
            const saveBtnContent = document.getElementById('save-btn-content');
            const roomNumber = document.getElementById('roomNumber').value;
            
            if (!saveBtn || !saveBtnContent) return;
            
            // Add transition for smooth color changes
            saveBtn.style.transition = 'background 0.3s ease, box-shadow 0.3s ease';
            
            // Update button text
            if (roomNumber) {
                saveBtnContent.innerHTML = `üíæ Save Room ${roomNumber} - <strong>${status}</strong>`;
            } else {
                saveBtnContent.innerHTML = `üíæ Save Inspection - <strong>${status}</strong>`;
            }
            
            // Update button color based on status
            if (statusClass === 'outstanding') {
                saveBtn.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                saveBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
            } else if (statusClass === 'fail') {
                saveBtn.style.background = 'linear-gradient(135deg, var(--error), #dc2626)';
                saveBtn.style.boxShadow = '0 4px 12px rgba(239, 68, 68, 0.4)';
            } else {
                // Pass status (green)
                saveBtn.style.background = 'linear-gradient(135deg, var(--success), #059669)';
                saveBtn.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
            }
        }

        function updateRoomDropdown(preserveSelection) {
            const roomSelect = document.getElementById('roomNumber');
            const scheduledMode = document.querySelector('input[name="roomMode"]:checked').value === 'scheduled';
            const currentSelection = preserveSelection ? roomSelect.value : '';

            roomSelect.innerHTML = '<option value="">Select Room Number</option>';

            if (scheduledMode) {
                const rooms = getInspectionListRooms();
                
                if (rooms.length > 0) {
                    rooms.sort((a, b) => parseInt(a) - parseInt(b));
                    rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room;
                        option.textContent = `Room ${room}`;
                        roomSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.textContent = 'No rooms in selected list';
                    option.disabled = true;
                    roomSelect.appendChild(option);
                }
            } else {
                const group200 = document.createElement('optgroup');
                group200.label = '200 Series';
                for (let i = 201; i <= 299; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    group200.appendChild(option);
                }
                roomSelect.appendChild(group200);

                const group300 = document.createElement('optgroup');
                group300.label = '300 Series';
                for (let i = 301; i <= 399; i++) {
                    const option = document.createElement('option');
                    option.value = i;
                    option.textContent = i;
                    group300.appendChild(option);
                }
                roomSelect.appendChild(group300);
            }

            if (preserveSelection && currentSelection) {
                roomSelect.value = currentSelection;
            }
            
            // Add event listener to update save button when room changes
            roomSelect.removeEventListener('change', handleRoomChange);
            roomSelect.addEventListener('change', handleRoomChange);
            
            // Update button immediately with current selection
            updateScore();
        }
        
        function handleRoomChange() {
            updateScore();
        }

        function updateInspectorDropdown() {
            const select = document.getElementById('inspectorName');
            const currentValue = select.value;
            select.innerHTML = '<option value="">Select Inspector</option>';
            inspectorNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });
            if (currentValue) select.value = currentValue;
        }

        function setupRoomTiles() {
            const container = document.getElementById('room-tiles-grid');
            container.innerHTML = '';
            for (let i = 201; i <= 299; i++) createRoomTile(container, i);
            for (let i = 301; i <= 399; i++) createRoomTile(container, i);
        }

        function createRoomTile(container, roomNumber) {
            const tile = document.createElement('div');
            tile.className = 'room-tile';
            tile.setAttribute('data-room', roomNumber);
            
            const props = roomProperties[roomNumber] || {};
            
            let html = `<div class="room-number">${roomNumber}</div>`;
            
            if (props.shift || props.gender) {
                html += '<div class="room-badges">';
                if (props.shift) {
                    const shiftClass = `shift-${props.shift.toLowerCase()}`;
                    html += `<span class="room-badge ${shiftClass}">${props.shift}</span>`;
                }
                if (props.gender) {
                    const genderClass = props.gender === 'Male' ? 'gender-male' : 'gender-female';
                    const genderIcon = props.gender === 'Male' ? 'üë®' : 'üë©';
                    html += `<span class="room-badge ${genderClass}">${genderIcon}</span>`;
                }
                html += '</div>';
            }
            
            tile.innerHTML = html;
            tile.onclick = () => toggleRoomTile(roomNumber);
            container.appendChild(tile);
        }

        function toggleRoomTile(roomNumber) {
            const tile = document.querySelector(`.room-tile[data-room="${roomNumber}"]`);
            const roomStr = String(roomNumber);
            if (selectedRoomTiles.has(roomStr)) {
                selectedRoomTiles.delete(roomStr);
                tile.classList.remove('selected');
            } else {
                selectedRoomTiles.add(roomStr);
                tile.classList.add('selected');
            }
        }

        function selectAllRooms() {
            selectedRoomTiles.clear();
            document.querySelectorAll('.room-tile').forEach(tile => {
                const roomNumber = tile.getAttribute('data-room');
                selectedRoomTiles.add(roomNumber);
                tile.classList.add('selected');
            });
        }

        function clearAllSelectedRooms() {
            selectedRoomTiles.clear();
            document.querySelectorAll('.room-tile').forEach(tile => {
                tile.classList.remove('selected');
            });
        }

        function updateScheduledRoomsDisplay() {
            const container = document.getElementById('scheduled-rooms');
            
            if (!activeListId) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No active list selected</p>';
                return;
            }

            const list = inspectionLists.find(l => l.id === activeListId);
            if (!list || list.rooms.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No rooms in this list yet</p>';
                return;
            }

            const sorted = list.rooms.slice().sort((a, b) => parseInt(a) - parseInt(b));
            container.innerHTML = sorted.map(room => {
                const props = roomProperties[room] || {};
                let badges = '';
                
                if (props.shift) {
                    let shiftColor, shiftTextColor;
                    if (props.shift === 'S') {
                        shiftColor = 'rgba(16, 185, 129, 0.2)';
                        shiftTextColor = '#10b981';
                    } else if (props.shift === 'T') {
                        shiftColor = 'rgba(245, 158, 11, 0.2)';
                        shiftTextColor = '#f59e0b';
                    } else if (props.shift === 'R') {
                        shiftColor = 'rgba(239, 68, 68, 0.2)';
                        shiftTextColor = '#ef4444';
                    }
                    badges += `<span style="padding: 4px 8px; background: ${shiftColor}; color: ${shiftTextColor}; border-radius: 6px; font-size: 11px; font-weight: 700;">${props.shift}</span>`;
                }
                if (props.gender) {
                    const genderColor = props.gender === 'Male' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(236, 72, 153, 0.2)';
                    const genderTextColor = props.gender === 'Male' ? '#3b82f6' : 'var(--accent)';
                    const genderIcon = props.gender === 'Male' ? 'üë®' : 'üë©';
                    badges += `<span style="padding: 4px 8px; background: ${genderColor}; color: ${genderTextColor}; border-radius: 6px; font-size: 11px; font-weight: 700; margin-left: 4px;">${genderIcon} ${props.gender}</span>`;
                }

                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface-light); border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 600;">Room ${room}</span>
                            ${badges}
                        </div>
                        <button onclick="removeRoomFromActiveList('${room}')" style="background: var(--error); color: white; border: none; width: 32px; height: 32px; border-radius: 8px; cursor: pointer;">√ó</button>
                    </div>
                `;
            }).join('');
        }

        async function removeRoomFromActiveList(roomNumber) {
            if (!activeListId) return;

            const list = inspectionLists.find(l => l.id === activeListId);
            if (!list) return;

            const index = list.rooms.indexOf(String(roomNumber));
            if (index > -1) {
                list.rooms.splice(index, 1);
                await saveData();
                updateScheduledRoomsDisplay();
                updateRoomDropdown();
                updateActiveListSelect();
                updateInspectionListSelect();
            }
        }

        async function saveSchedule() {
            await saveData();
            alert('Schedule saved successfully!');
        }

        async function saveInspection() {
            if (isLoading) return;

            const roomNumber = document.getElementById('roomNumber').value;
            const inspectorName = document.getElementById('inspectorName').value;
            const notes = document.getElementById('notes').value;

            if (!roomNumber) {
                alert('Please select a room number');
                return;
            }

            showLoading(true);

            try {
                const selectedDemerits = [];
                const selectedAutoFailure = [];
                
                document.querySelectorAll('.demerit-item[data-type="regular"].checked').forEach(item => {
                    const index = parseInt(item.getAttribute('data-index'));
                    selectedDemerits.push(demerits[index]);
                });

                document.querySelectorAll('.demerit-item[data-type="auto-failure"].checked').forEach(item => {
                    const index = parseInt(item.getAttribute('data-index'));
                    selectedAutoFailure.push(autoFailureDemerits[index]);
                });

                const regularScore = selectedDemerits.length;
                const autoFailureScore = selectedAutoFailure.length * 4;
                const totalScore = regularScore + autoFailureScore;
                
                let status;
                if (totalScore === 0) {
                    status = 'OUTSTANDING';
                } else if (totalScore >= 1 && totalScore <= 3) {
                    status = 'PASSED';
                } else {
                    status = 'FAILED';
                }

                const inspection = {
                    id: editingId || Date.now(),
                    roomNumber,
                    inspectionDate: new Date().toISOString().split('T')[0],
                    inspectorName,
                    demerits: selectedDemerits,
                    autoFailureDemerits: selectedAutoFailure,
                    regularScore,
                    autoFailureScore,
                    score: totalScore,
                    status: status,
                    notes,
                    timestamp: new Date().toISOString()
                };

                if (editingId) {
                    const index = inspections.findIndex(i => i.id === editingId);
                    if (index !== -1) inspections[index] = inspection;
                } else {
                    const inspectionListSelect = document.getElementById('inspection-list-select');
                    const selectedListId = inspectionListSelect ? inspectionListSelect.value : '';
                    
                    if (selectedListId) {
                        const list = inspectionLists.find(l => l.id === selectedListId);
                        if (list) {
                            const roomIndex = list.rooms.indexOf(String(roomNumber));
                            if (roomIndex > -1) {
                                list.rooms.splice(roomIndex, 1);
                            }
                        }
                    } else {
                        inspectionLists.forEach(list => {
                            const roomIndex = list.rooms.indexOf(String(roomNumber));
                            if (roomIndex > -1) {
                                list.rooms.splice(roomIndex, 1);
                            }
                        });
                    }
                    
                    const roomIndex = scheduledRooms.indexOf(String(roomNumber));
                    if (roomIndex > -1) {
                        scheduledRooms.splice(roomIndex, 1);
                    }
                    
                    updateScheduledRoomsDisplay();
                    updateRoomDropdown();
                    updateActiveListSelect();
                    updateInspectionListSelect();
                    
                    inspections.push(inspection);
                }

                await saveData();
                
                // Check if we're inspecting from a list and auto-load next room
                const scheduledMode = document.querySelector('input[name="roomMode"]:checked').value === 'scheduled';
                const availableRooms = getInspectionListRooms();
                
                if (scheduledMode && availableRooms.length > 0) {
                    // Auto-load next room
                    const nextRoom = availableRooms[0];
                    
                    showMessage(`‚úÖ Saved! Loading Room ${nextRoom}...`, 'success');
                    
                    // Reset form but keep inspector name
                    const savedInspector = document.getElementById('inspectorName').value;
                    resetForm();
                    document.getElementById('inspectorName').value = savedInspector;
                    
                    // Load next room after a brief delay
                    setTimeout(() => {
                        updateRoomDropdown();
                        document.getElementById('roomNumber').value = nextRoom;
                        updateScore(); // Update button with new room
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 500);
                } else {
                    // No more rooms in list
                    resetForm();
                    if (scheduledMode && availableRooms.length === 0) {
                        showMessage('üéâ All rooms inspected!', 'success');
                    } else {
                        showMessage('Inspection saved successfully!', 'success');
                    }
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error saving:', error);
                showError('Failed to save inspection');
            } finally {
                showLoading(false);
            }
        }

        function showMessage(text, type) {
            var scoreDisplay = document.getElementById('score-display');
            var originalHTML = scoreDisplay.innerHTML;
            var originalClass = scoreDisplay.className;

            if (type === 'error') {
                scoreDisplay.className = 'score-card fail';
                scoreDisplay.innerHTML = `
                    <div class="score-number" style="font-size: 24px;">‚ùå</div>
                    <div class="score-label">${text}</div>
                `;
            } else {
                scoreDisplay.className = 'score-card';
                scoreDisplay.innerHTML = `
                    <div class="score-number" style="font-size: 24px;">‚úÖ</div>
                    <div class="score-label">${text}</div>
                `;
            }

            setTimeout(function () {
                scoreDisplay.innerHTML = originalHTML;
                scoreDisplay.className = originalClass;
            }, 3000);
        }

        function resetForm() {
            editingId = null;
            document.getElementById('form-title').textContent = 'New Inspection';
            const cancelBtn = document.getElementById('cancel-btn');
            if (cancelBtn) {
                cancelBtn.style.display = 'none';
            }
            document.getElementById('roomNumber').value = '';
            document.getElementById('notes').value = '';
            document.querySelectorAll('.demerit-item').forEach(item => item.classList.remove('checked'));
            updateScore();
            
            // Reset save button to default
            const saveBtn = document.getElementById('save-btn');
            const saveBtnContent = document.getElementById('save-btn-content');
            if (saveBtn && saveBtnContent) {
                saveBtnContent.innerHTML = 'üíæ Save Inspection - <strong>OUTSTANDING</strong>';
                saveBtn.style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                saveBtn.style.boxShadow = '0 4px 12px rgba(59, 130, 246, 0.4)';
            }
        }

        function editInspection(id) {
            const inspection = inspections.find(i => i.id === id);
            if (!inspection) return;

            showTab('new');

            setTimeout(() => {
                editingId = id;
                document.getElementById('form-title').textContent = 'Edit Inspection';
                const cancelBtn = document.getElementById('cancel-btn');
                if (cancelBtn) {
                    cancelBtn.style.display = 'block';
                }
                
                const allRoomsRadio = document.querySelector('input[name="roomMode"][value="all"]');
                if (allRoomsRadio) {
                    allRoomsRadio.checked = true;
                    updateRoomDropdown();
                }
                
                document.getElementById('roomNumber').value = inspection.roomNumber;
                document.getElementById('inspectorName').value = inspection.inspectorName || '';
                document.getElementById('notes').value = inspection.notes || '';

                document.querySelectorAll('.demerit-item').forEach(item => item.classList.remove('checked'));

                if (inspection.demerits) {
                    inspection.demerits.forEach(demerit => {
                        const index = demerits.indexOf(demerit);
                        if (index !== -1) {
                            const item = document.querySelector(`[data-type="regular"][data-index="${index}"]`);
                            if (item) item.classList.add('checked');
                        }
                    });
                }

                if (inspection.autoFailureDemerits) {
                    inspection.autoFailureDemerits.forEach(demerit => {
                        const index = autoFailureDemerits.indexOf(demerit);
                        if (index !== -1) {
                            const item = document.querySelector(`[data-type="auto-failure"][data-index="${index}"]`);
                            if (item) item.classList.add('checked');
                        }
                    });
                }

                updateScore();
                
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }, 100);
        }

        function cancelEdit() {
            resetForm();
        }

        async function deleteInspection(id) {
            const index = inspections.findIndex(i => i.id === id);
            if (index !== -1) {
                inspections.splice(index, 1);
                await saveData();
                loadInspectionsList();
            }
        }

        async function deleteAllInspections() {
            if (inspections.length === 0) {
                console.log('No inspections to delete');
                return;
            }

            var button = event.target;
            var clickCount = parseInt(button.getAttribute('data-click-count') || '0');

            clickCount++;
            button.setAttribute('data-click-count', clickCount);

            var originalText = button.textContent;

            if (clickCount === 1) {
                button.textContent = `Click 2 More Times (${inspections.length} records)`;
                button.style.background = 'linear-gradient(135deg, var(--warning), #d97706)';

                setTimeout(function () {
                    button.setAttribute('data-click-count', '0');
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--error), #dc2626)';
                }, 5000);

            } else if (clickCount === 2) {
                button.textContent = 'FINAL WARNING - Click Once More';
                button.style.background = 'linear-gradient(135deg, #dc2626, #991b1b)';

            } else if (clickCount >= 3) {
                try {
                    inspections = [];
                    await saveData();
                    loadInspectionsList();

                    button.setAttribute('data-click-count', '0');
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--error), #dc2626)';

                    console.log('All inspections deleted successfully');
                } catch (error) {
                    console.error('Error deleting all inspections:', error);
                    showError('Failed to delete all inspections. Please try again.');
                }
            }
        }

        function loadInspectionsList() {
            const list = document.getElementById('inspections-list');
            if (inspections.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No inspections recorded yet</p>';
                return;
            }

            const sorted = inspections.slice().sort((a, b) => new Date(b.inspectionDate) - new Date(a.inspectionDate));
            
            if (settings.viewMode === 'card') {
                list.innerHTML = sorted.map(inspection => renderCardView(inspection)).join('');
            } else if (settings.viewMode === 'list') {
                list.innerHTML = sorted.map(inspection => renderListView(inspection)).join('');
            } else if (settings.viewMode === 'table') {
                list.innerHTML = renderTableView(sorted);
            }
        }

        function renderCardView(inspection) {
            const props = roomProperties[inspection.roomNumber] || {};
            const statusClass = inspection.status === 'OUTSTANDING' ? 'outstanding' : 
                               inspection.status === 'PASSED' ? 'pass' : 'fail';
            
            const padding = settings.density === 'compact' ? '12px' : 
                           settings.density === 'spacious' ? '28px' : '20px';
            const gap = settings.density === 'compact' ? '6px' : 
                       settings.density === 'spacious' ? '12px' : '8px';
            const fontSize = settings.density === 'compact' ? '13px' : 
                            settings.density === 'spacious' ? '15px' : '14px';
            
            let badges = '';
            if (settings.showFields.shift && props.shift) {
                let shiftColor, shiftTextColor;
                if (props.shift === 'S') {
                    shiftColor = 'rgba(16, 185, 129, 0.2)';
                    shiftTextColor = '#10b981';
                } else if (props.shift === 'T') {
                    shiftColor = 'rgba(245, 158, 11, 0.2)';
                    shiftTextColor = '#f59e0b';
                } else if (props.shift === 'R') {
                    shiftColor = 'rgba(239, 68, 68, 0.2)';
                    shiftTextColor = '#ef4444';
                }
                badges += `<span style="padding: 4px 8px; background: ${shiftColor}; border-radius: 6px; font-size: 10px; font-weight: 700; color: ${shiftTextColor}; margin-left: 8px;">${props.shift}</span>`;
            }
            if (settings.showFields.gender && props.gender) {
                const genderColor = props.gender === 'Male' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(236, 72, 153, 0.2)';
                const genderTextColor = props.gender === 'Male' ? '#3b82f6' : 'var(--accent)';
                const genderIcon = props.gender === 'Male' ? 'üë®' : 'üë©';
                badges += `<span style="padding: 4px 8px; background: ${genderColor}; border-radius: 6px; font-size: 10px; font-weight: 700; color: ${genderTextColor}; margin-left: 4px;">${genderIcon}</span>`;
            }

            let details = '';
            if (settings.showFields.date) {
                details += `<div><strong>Date:</strong> ${new Date(inspection.inspectionDate).toLocaleDateString()}</div>`;
            }
            if (settings.showFields.inspector) {
                details += `<div><strong>Inspector:</strong> ${inspection.inspectorName || 'Not specified'}</div>`;
            }
            if (settings.showFields.score) {
                details += `<div><strong>Score:</strong> ${inspection.score} points</div>`;
            }
            if (settings.showFields.violations && inspection.demerits && inspection.demerits.length > 0) {
                details += `<div><strong>Violations:</strong> ${inspection.demerits.join(', ')}</div>`;
            }
            if (settings.showFields.violations && inspection.autoFailureDemerits && inspection.autoFailureDemerits.length > 0) {
                details += `<div><strong>Auto-Fail:</strong> ${inspection.autoFailureDemerits.join(', ')}</div>`;
            }
            if (settings.showFields.notes && inspection.notes) {
                details += `<div><strong>Notes:</strong> ${inspection.notes}</div>`;
            }

            return `
                <div class="inspection-card ${statusClass}" style="padding: ${padding};">
                    <div class="inspection-header">
                        <div>
                            <h3 class="inspection-title">Room ${inspection.roomNumber}${badges}</h3>
                        </div>
                        <span class="inspection-badge ${statusClass}">${inspection.status}</span>
                    </div>
                    <div style="display: grid; gap: ${gap}; font-size: ${fontSize}; color: var(--text-secondary);">
                        ${details}
                    </div>
                    <div class="inspection-actions">
                        <button class="btn btn-warning btn-small" onclick="editInspection(${inspection.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-small" onclick="deleteInspection(${inspection.id})">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `;
        }

        function renderListView(inspection) {
            const props = roomProperties[inspection.roomNumber] || {};
            const statusClass = inspection.status === 'OUTSTANDING' ? 'outstanding' : 
                               inspection.status === 'PASSED' ? 'pass' : 'fail';
            const statusColor = statusClass === 'outstanding' ? '#3b82f6' :
                               statusClass === 'pass' ? '#10b981' : '#ef4444';
            
            const padding = settings.density === 'compact' ? '8px 12px' : 
                           settings.density === 'spacious' ? '16px 20px' : '12px 16px';
            const fontSize = settings.density === 'compact' ? '13px' : 
                            settings.density === 'spacious' ? '15px' : '14px';
            
            let badges = '';
            if (settings.showFields.shift && props.shift) {
                let shiftColor, shiftTextColor;
                if (props.shift === 'S') {
                    shiftColor = 'rgba(16, 185, 129, 0.2)';
                    shiftTextColor = '#10b981';
                } else if (props.shift === 'T') {
                    shiftColor = 'rgba(245, 158, 11, 0.2)';
                    shiftTextColor = '#f59e0b';
                } else if (props.shift === 'R') {
                    shiftColor = 'rgba(239, 68, 68, 0.2)';
                    shiftTextColor = '#ef4444';
                }
                badges += `<span style="padding: 2px 6px; background: ${shiftColor}; border-radius: 4px; font-size: 10px; font-weight: 700; color: ${shiftTextColor}; margin-left: 6px;">${props.shift}</span>`;
            }
            if (settings.showFields.gender && props.gender) {
                const genderIcon = props.gender === 'Male' ? 'üë®' : 'üë©';
                badges += `<span style="margin-left: 4px; font-size: 10px;">${genderIcon}</span>`;
            }

            let infoItems = [];
            if (settings.showFields.date) {
                infoItems.push(new Date(inspection.inspectionDate).toLocaleDateString());
            }
            if (settings.showFields.inspector) {
                infoItems.push(inspection.inspectorName || 'Unknown');
            }
            if (settings.showFields.score) {
                infoItems.push(`${inspection.score} pts`);
            }
            const info = infoItems.join(' ‚Ä¢ ');

            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: ${padding}; background: var(--surface); border: 1px solid var(--border); border-left: 4px solid ${statusColor}; margin-bottom: 4px; border-radius: 8px; font-size: ${fontSize};">
                    <div style="flex: 1; display: flex; align-items: center; gap: 12px;">
                        <span style="font-weight: 700; color: var(--text-primary);">Room ${inspection.roomNumber}${badges}</span>
                        <span style="color: var(--text-muted); font-size: 12px;">${info}</span>
                        <span style="padding: 2px 8px; background: ${statusColor}; color: white; border-radius: 12px; font-size: 10px; font-weight: 700;">${inspection.status}</span>
                    </div>
                    <div style="display: flex; gap: 6px;">
                        <button onclick="editInspection(${inspection.id})" style="padding: 4px 12px; background: var(--warning); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Edit</button>
                        <button onclick="deleteInspection(${inspection.id})" style="padding: 4px 12px; background: var(--error); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">Delete</button>
                    </div>
                </div>
            `;
        }

        function renderTableView(inspections) {
            const fontSize = settings.density === 'compact' ? '12px' : 
                            settings.density === 'spacious' ? '14px' : '13px';
            const cellPadding = settings.density === 'compact' ? '6px 8px' : 
                               settings.density === 'spacious' ? '12px 16px' : '8px 12px';
            
            let headers = '<th style="padding: ' + cellPadding + '; text-align: left; font-weight: 700; background: var(--surface-light); border-bottom: 2px solid var(--border);">Room</th>';
            if (settings.showFields.date) headers += '<th style="padding: ' + cellPadding + '; text-align: left; font-weight: 700; background: var(--surface-light); border-bottom: 2px solid var(--border);">Date</th>';
            if (settings.showFields.inspector) headers += '<th style="padding: ' + cellPadding + '; text-align: left; font-weight: 700; background: var(--surface-light); border-bottom: 2px solid var(--border);">Inspector</th>';
            if (settings.showFields.score) headers += '<th style="padding: ' + cellPadding + '; text-align: left; font-weight: 700; background: var(--surface-light); border-bottom: 2px solid var(--border);">Score</th>';
            headers += '<th style="padding: ' + cellPadding + '; text-align: left; font-weight: 700; background: var(--surface-light); border-bottom: 2px solid var(--border);">Status</th>';
            headers += '<th style="padding: ' + cellPadding + '; text-align: center; font-weight: 700; background: var(--surface-light); border-bottom: 2px solid var(--border);">Actions</th>';
            
            const rows = inspections.map(inspection => {
                const props = roomProperties[inspection.roomNumber] || {};
                const statusClass = inspection.status === 'OUTSTANDING' ? 'outstanding' : 
                                   inspection.status === 'PASSED' ? 'pass' : 'fail';
                const statusColor = statusClass === 'outstanding' ? '#3b82f6' :
                                   statusClass === 'pass' ? '#10b981' : '#ef4444';
                
                let badges = '';
                if (settings.showFields.shift && props.shift) {
                    let shiftColor, shiftTextColor;
                    if (props.shift === 'S') {
                        shiftColor = 'rgba(16, 185, 129, 0.2)';
                        shiftTextColor = '#10b981';
                    } else if (props.shift === 'T') {
                        shiftColor = 'rgba(245, 158, 11, 0.2)';
                        shiftTextColor = '#f59e0b';
                    } else if (props.shift === 'R') {
                        shiftColor = 'rgba(239, 68, 68, 0.2)';
                        shiftTextColor = '#ef4444';
                    }
                    badges += `<span style="padding: 2px 6px; background: ${shiftColor}; border-radius: 4px; font-size: 9px; font-weight: 700; color: ${shiftTextColor}; margin-left: 4px;">${props.shift}</span>`;
                }
                if (settings.showFields.gender && props.gender) {
                    const genderIcon = props.gender === 'Male' ? 'üë®' : 'üë©';
                    badges += `<span style="margin-left: 4px; font-size: 9px;">${genderIcon}</span>`;
                }
                
                let cells = `<td style="padding: ${cellPadding}; border-bottom: 1px solid var(--border); font-weight: 600;">${inspection.roomNumber}${badges}</td>`;
                if (settings.showFields.date) cells += `<td style="padding: ${cellPadding}; border-bottom: 1px solid var(--border);">${new Date(inspection.inspectionDate).toLocaleDateString()}</td>`;
                if (settings.showFields.inspector) cells += `<td style="padding: ${cellPadding}; border-bottom: 1px solid var(--border);">${inspection.inspectorName || 'N/A'}</td>`;
                if (settings.showFields.score) cells += `<td style="padding: ${cellPadding}; border-bottom: 1px solid var(--border);">${inspection.score}</td>`;
                cells += `<td style="padding: ${cellPadding}; border-bottom: 1px solid var(--border);"><span style="padding: 2px 8px; background: ${statusColor}; color: white; border-radius: 12px; font-size: 10px; font-weight: 700; white-space: nowrap;">${inspection.status}</span></td>`;
                cells += `<td style="padding: ${cellPadding}; border-bottom: 1px solid var(--border); text-align: center;">
                    <button onclick="editInspection(${inspection.id})" style="padding: 4px 8px; background: var(--warning); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 4px;">Edit</button>
                    <button onclick="deleteInspection(${inspection.id})" style="padding: 4px 8px; background: var(--error); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;">Del</button>
                </td>`;
                
                return `<tr style="transition: background 0.2s;" onmouseover="this.style.background='var(--surface-light)'" onmouseout="this.style.background='transparent'">${cells}</tr>`;
            }).join('');
            
            return `
                <div style="overflow-x: auto; border-radius: 12px; border: 1px solid var(--border);">
                    <table style="width: 100%; border-collapse: collapse; background: var(--surface); font-size: ${fontSize};">
                        <thead>
                            <tr>${headers}</tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        function generateReport() {
            const content = document.getElementById('report-content');
            const filteredInspections = getFilteredInspections('report');
            
            if (filteredInspections.length === 0) {
                content.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No data available for selected date range</p>';
                return;
            }

            const total = filteredInspections.length;
            const outstanding = filteredInspections.filter(i => i.status === 'OUTSTANDING').length;
            const passed = filteredInspections.filter(i => i.status === 'PASSED').length;
            const failed = filteredInspections.filter(i => i.status === 'FAILED').length;
            const passRate = (((outstanding + passed) / total) * 100).toFixed(1);

            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            let dateRangeText = '';
            if (startDate || endDate) {
                dateRangeText = `<p style="text-align: center; color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
                    Date Range: ${startDate || 'Beginning'} to ${endDate || 'Present'}
                </p>`;
            }

            content.innerHTML = dateRangeText + `
                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-number">${total}</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: #3b82f6;">${outstanding}</div>
                        <div class="stat-label">Outstanding</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: var(--success);">${passed}</div>
                        <div class="stat-label">Passed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" style="color: var(--error);">${failed}</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${passRate}%</div>
                        <div class="stat-label">Pass Rate</div>
                    </div>
                </div>
                <div style="display: grid; gap: 12px; margin-top: 24px;">
                    <button class="btn btn-primary" onclick="window.print()">üñ®Ô∏è Print Report</button>
                    <button class="btn btn-success" onclick="exportToCSV()">üìä Export CSV</button>
                    <button class="btn btn-secondary" onclick="exportToExcel()">üìã Export Excel</button>
                </div>
            `;
        }

        function setReportDateRange(range) {
            const startDateInput = document.getElementById('report-start-date');
            const endDateInput = document.getElementById('report-end-date');
            const today = new Date();
            
            if (range === 'all') {
                startDateInput.value = '';
                endDateInput.value = '';
            } else if (range === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                startDateInput.value = weekAgo.toISOString().split('T')[0];
                endDateInput.value = today.toISOString().split('T')[0];
            } else if (range === 'month') {
                const monthAgo = new Date(today);
                monthAgo.setDate(monthAgo.getDate() - 30);
                startDateInput.value = monthAgo.toISOString().split('T')[0];
                endDateInput.value = today.toISOString().split('T')[0];
            }
            
            generateReport();
        }

        function setAnalyticsDateRange(range) {
            const startDateInput = document.getElementById('analytics-start-date');
            const endDateInput = document.getElementById('analytics-end-date');
            const today = new Date();
            
            if (range === 'all') {
                startDateInput.value = '';
                endDateInput.value = '';
            } else if (range === 'week') {
                const weekAgo = new Date(today);
                weekAgo.setDate(weekAgo.getDate() - 7);
                startDateInput.value = weekAgo.toISOString().split('T')[0];
                endDateInput.value = today.toISOString().split('T')[0];
            } else if (range === 'month') {
                const monthAgo = new Date(today);
                monthAgo.setDate(monthAgo.getDate() - 30);
                startDateInput.value = monthAgo.toISOString().split('T')[0];
                endDateInput.value = today.toISOString().split('T')[0];
            }
        }

        function getFilteredInspections(source) {
            let startDate, endDate;
            
            if (source === 'report') {
                startDate = document.getElementById('report-start-date').value;
                endDate = document.getElementById('report-end-date').value;
            } else {
                startDate = document.getElementById('analytics-start-date').value;
                endDate = document.getElementById('analytics-end-date').value;
            }
            
            if (!startDate && !endDate) {
                return inspections;
            }
            
            return inspections.filter(inspection => {
                const inspectionDate = inspection.inspectionDate;
                
                if (startDate && inspectionDate < startDate) {
                    return false;
                }
                
                if (endDate && inspectionDate > endDate) {
                    return false;
                }
                
                return true;
            });
        }

        function exportToCSV() {
            const filteredInspections = getFilteredInspections('report');
            
            if (filteredInspections.length === 0) return;

            const headers = ['Room Number', 'Shift', 'Gender', 'Date', 'Inspector', 'Regular Score', 'Auto-Failure Score', 'Total Score', 'Status', 'Notes'];
            autoFailureDemerits.forEach(d => headers.push(d + ' (AUTO-FAIL)'));
            demerits.forEach(d => headers.push(d));

            let csv = headers.join(',') + '\n';

            filteredInspections.forEach(inspection => {
                const props = roomProperties[inspection.roomNumber] || {};
                const row = [
                    inspection.roomNumber,
                    props.shift || '',
                    props.gender || '',
                    inspection.inspectionDate,
                    inspection.inspectorName || '',
                    inspection.regularScore || 0,
                    inspection.autoFailureScore || 0,
                    inspection.score,
                    inspection.status,
                    '"' + (inspection.notes || '').replace(/"/g, '""') + '"'
                ];

                autoFailureDemerits.forEach(demerit => {
                    row.push(inspection.autoFailureDemerits && inspection.autoFailureDemerits.includes(demerit) ? 'X' : '');
                });

                demerits.forEach(demerit => {
                    row.push(inspection.demerits && inspection.demerits.includes(demerit) ? 'X' : '');
                });

                csv += row.join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dorm-inspection-report-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportToExcel() {
            const filteredInspections = getFilteredInspections('report');
            
            if (filteredInspections.length === 0) {
                alert('No data to export');
                return;
            }

            try {
                const wb = XLSX.utils.book_new();

                const summaryData = [];
                const total = filteredInspections.length;
                const outstanding = filteredInspections.filter(i => i.status === 'OUTSTANDING').length;
                const passed = filteredInspections.filter(i => i.status === 'PASSED').length;
                const failed = filteredInspections.filter(i => i.status === 'FAILED').length;
                const passRate = (((outstanding + passed) / total) * 100).toFixed(1);

                summaryData.push(['DORM INSPECTION REPORT SUMMARY']);
                summaryData.push([]);
                summaryData.push(['Report Generated:', new Date().toLocaleString()]);
                
                const startDate = document.getElementById('report-start-date').value;
                const endDate = document.getElementById('report-end-date').value;
                if (startDate || endDate) {
                    summaryData.push(['Date Range:', `${startDate || 'Beginning'} to ${endDate || 'Present'}`]);
                }
                
                summaryData.push([]);
                summaryData.push(['STATISTICS']);
                summaryData.push(['Total Inspections:', total]);
                summaryData.push(['Outstanding:', outstanding]);
                summaryData.push(['Passed:', passed]);
                summaryData.push(['Failed:', failed]);
                summaryData.push(['Pass Rate:', passRate + '%']);

                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                
                wsSummary['!cols'] = [
                    { wch: 25 },
                    { wch: 30 }
                ];

                XLSX.utils.book_append_sheet(wb, wsSummary, 'Summary');

                const detailsData = [];
                
                const headers = [
                    'Room Number',
                    'Shift',
                    'Gender',
                    'Date',
                    'Inspector',
                    'Regular Score',
                    'Auto-Fail Score',
                    'Total Score',
                    'Status',
                    'Regular Violations',
                    'Auto-Failure Violations',
                    'Notes'
                ];
                detailsData.push(headers);

                filteredInspections.forEach(inspection => {
                    const props = roomProperties[inspection.roomNumber] || {};
                    const row = [
                        inspection.roomNumber,
                        props.shift || '',
                        props.gender || '',
                        inspection.inspectionDate,
                        inspection.inspectorName || 'Not specified',
                        inspection.regularScore || 0,
                        inspection.autoFailureScore || 0,
                        inspection.score,
                        inspection.status,
                        inspection.demerits ? inspection.demerits.join(', ') : '',
                        inspection.autoFailureDemerits ? inspection.autoFailureDemerits.join(', ') : '',
                        inspection.notes || ''
                    ];
                    detailsData.push(row);
                });

                const wsDetails = XLSX.utils.aoa_to_sheet(detailsData);
                
                wsDetails['!cols'] = [
                    { wch: 12 },
                    { wch: 8 },
                    { wch: 10 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 14 },
                    { wch: 14 },
                    { wch: 12 },
                    { wch: 12 },
                    { wch: 40 },
                    { wch: 40 },
                    { wch: 30 }
                ];

                XLSX.utils.book_append_sheet(wb, wsDetails, 'Detailed Inspections');

                const violationsData = [];
                violationsData.push(['VIOLATIONS BREAKDOWN']);
                violationsData.push([]);
                violationsData.push(['Room', 'Date', 'Inspector', 'Violation Type', 'Violation']);

                filteredInspections.forEach(inspection => {
                    if (inspection.demerits && inspection.demerits.length > 0) {
                        inspection.demerits.forEach(demerit => {
                            violationsData.push([
                                inspection.roomNumber,
                                inspection.inspectionDate,
                                inspection.inspectorName || 'Not specified',
                                'Regular',
                                demerit
                            ]);
                        });
                    }
                    
                    if (inspection.autoFailureDemerits && inspection.autoFailureDemerits.length > 0) {
                        inspection.autoFailureDemerits.forEach(demerit => {
                            violationsData.push([
                                inspection.roomNumber,
                                inspection.inspectionDate,
                                inspection.inspectorName || 'Not specified',
                                'AUTO-FAILURE',
                                demerit
                            ]);
                        });
                    }
                });

                const wsViolations = XLSX.utils.aoa_to_sheet(violationsData);
                wsViolations['!cols'] = [
                    { wch: 12 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 15 },
                    { wch: 50 }
                ];

                XLSX.utils.book_append_sheet(wb, wsViolations, 'Violations Breakdown');

                const inspectorData = [];
                inspectorData.push(['INSPECTOR PERFORMANCE ANALYSIS']);
                inspectorData.push([]);
                inspectorData.push(['Inspector', 'Total Inspections', 'Passed', 'Failed', 'Failure Rate %', 'Avg Score', 'Unique Rooms']);

                const inspectorStats = {};
                filteredInspections.forEach(inspection => {
                    const inspector = inspection.inspectorName || 'Unknown';
                    if (!inspectorStats[inspector]) {
                        inspectorStats[inspector] = {
                            total: 0,
                            passed: 0,
                            failed: 0,
                            totalScore: 0,
                            rooms: new Set()
                        };
                    }
                    
                    const stats = inspectorStats[inspector];
                    stats.total++;
                    stats.totalScore += inspection.score;
                    stats.rooms.add(inspection.roomNumber);
                    
                    if (inspection.status === 'PASSED' || inspection.status === 'OUTSTANDING') {
                        stats.passed++;
                    } else {
                        stats.failed++;
                    }
                });

                Object.keys(inspectorStats).sort((a, b) => inspectorStats[b].total - inspectorStats[a].total).forEach(inspector => {
                    const stats = inspectorStats[inspector];
                    const failureRate = ((stats.failed / stats.total) * 100).toFixed(1);
                    const avgScore = (stats.totalScore / stats.total).toFixed(1);
                    
                    inspectorData.push([
                        inspector,
                        stats.total,
                        stats.passed,
                        stats.failed,
                        failureRate,
                        avgScore,
                        stats.rooms.size
                    ]);
                });

                const wsInspector = XLSX.utils.aoa_to_sheet(inspectorData);
                wsInspector['!cols'] = [
                    { wch: 20 },
                    { wch: 18 },
                    { wch: 10 },
                    { wch: 10 },
                    { wch: 15 },
                    { wch: 12 },
                    { wch: 15 }
                ];

                XLSX.utils.book_append_sheet(wb, wsInspector, 'Inspector Performance');

                const fileName = `Dorm_Inspection_Report_${new Date().toISOString().split('T')[0]}.xlsx`;

                XLSX.writeFile(wb, fileName);

                if (document.getElementById('admin-log')) {
                    logAdmin('‚úì Excel report generated: ' + fileName);
                }

                const originalContent = document.getElementById('report-content').innerHTML;
                document.getElementById('report-content').innerHTML = `
                    <div style="text-align: center; padding: 40px; background: linear-gradient(135deg, var(--success), #059669); border-radius: 16px; color: white;">
                        <div style="font-size: 48px; margin-bottom: 16px;">‚úì</div>
                        <div style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Excel Report Generated!</div>
                        <div style="font-size: 14px; opacity: 0.9;">${fileName}</div>
                    </div>
                `;
                
                setTimeout(() => {
                    document.getElementById('report-content').innerHTML = originalContent;
                }, 3000);

            } catch (error) {
                console.error('Error generating Excel:', error);
                alert('Error generating Excel file: ' + error.message);
                if (document.getElementById('admin-log')) {
                    logAdmin('‚úó Excel export failed: ' + error.message);
                }
            }
        }

        // Remaining functions will continue in next message due to length...
        // [Admin panel functions, list management, room management, etc.]
        
        // Initialize
        window.onload = async function() {
            loadSettings();
            await loadData();
            setupForm();
            setupAdminPanel();
            setupKeyboardShortcuts();
            checkFirstTimeUser();
            displayLastSyncTime();
            
            setTimeout(() => {
                updateQuickViewButtons();
            }, 100);
        };

        function displayLastSyncTime() {
            const lastSync = localStorage.getItem('lastSyncTime');
            const syncElement = document.getElementById('last-sync-time');
            
            if (syncElement) {
                if (lastSync) {
                    const date = new Date(lastSync);
                    const now = new Date();
                    const diffMs = now - date;
                    const diffMins = Math.floor(diffMs / 60000);
                    
                    let timeAgo;
                    if (diffMins < 1) {
                        timeAgo = 'Just now';
                    } else if (diffMins < 60) {
                        timeAgo = diffMins + ' min ago';
                    } else if (diffMins < 1440) {
                        timeAgo = Math.floor(diffMins / 60) + ' hours ago';
                    } else {
                        timeAgo = Math.floor(diffMins / 1440) + ' days ago';
                    }
                    
                    syncElement.textContent = 'Last synced: ' + timeAgo;
                } else {
                    syncElement.textContent = 'Last synced: Never';
                }
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                if ((e.ctrlKey || e.metaKey) && (e.key === '=' || e.key === '+')) {
                    e.preventDefault();
                    adjustZoom(5);
                }
                else if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                    e.preventDefault();
                    adjustZoom(-5);
                }
                else if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                    e.preventDefault();
                    resetZoom();
                }
                else if (e.key === 'Escape') {
                    const tutorialOverlay = document.getElementById('tutorial-overlay');
                    if (tutorialOverlay && tutorialOverlay.style.display !== 'none') {
                        skipTutorial();
                    }
                }
            });
            
            window.addEventListener('resize', function() {
                const tutorialOverlay = document.getElementById('tutorial-overlay');
                if (tutorialOverlay && tutorialOverlay.style.display !== 'none') {
                    const step = tutorialSteps[currentTutorialStep];
                    const card = document.getElementById('tutorial-card');
                    const spotlight = document.getElementById('tutorial-spotlight');
                    setTimeout(() => positionTutorialElements(step, card, spotlight), 100);
                }
            });
        }

        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) closeSettings();
        });

        document.getElementById('room-management-modal').addEventListener('click', function(e) {
            if (e.target === this) closeRoomManagement();
        });

        document.getElementById('list-management-modal').addEventListener('click', function(e) {
            if (e.target === this) closeListManagement();
        });

        // Admin Panel Functions
        function setupAdminPanel() {
            const titleElement = document.getElementById('main-title');
            if (titleElement) {
                titleElement.addEventListener('click', handleTitleClick);
            }
            updateAdminStats();
            displayLastSyncTime();
        }

        function handleTitleClick() {
            titleClickCount++;
            
            if (titleClickTimer) {
                clearTimeout(titleClickTimer);
            }
            
            titleClickTimer = setTimeout(() => {
                titleClickCount = 0;
            }, 2000);
            
            if (titleClickCount >= 5) {
                titleClickCount = 0;
                clearTimeout(titleClickTimer);
                showAdminPanel();
            }
        }

        function showAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            if (adminPanel) {
                adminPanel.classList.add('active');
                updateAdminStats();
                updateListsDisplay();
                displayLastSyncTime();
                
                // Scroll to admin panel
                setTimeout(() => {
                    adminPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            }
        }

        function closeAdminPanel() {
            const adminPanel = document.getElementById('admin-panel');
            if (adminPanel) {
                adminPanel.classList.remove('active');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updateAdminStats() {
            // Update total inspections
            const totalInspections = document.getElementById('admin-total-inspections');
            if (totalInspections) {
                totalInspections.textContent = inspections.length;
            }
            
            // Update scheduled rooms count
            const scheduledRoomsCount = document.getElementById('admin-scheduled-rooms');
            if (scheduledRoomsCount) {
                let totalRooms = 0;
                inspectionLists.forEach(list => {
                    totalRooms += list.rooms.length;
                });
                scheduledRoomsCount.textContent = totalRooms;
            }
            
            // Update connection status
            const connectionStatus = document.getElementById('admin-connection-status');
            if (connectionStatus) {
                connectionStatus.textContent = isConnected ? '‚úì' : '‚úó';
                connectionStatus.style.color = isConnected ? 'var(--success)' : 'var(--error)';
            }
            
            // Update data size
            const dataSize = document.getElementById('admin-data-size');
            if (dataSize) {
                const size = JSON.stringify({
                    inspections,
                    scheduledRooms,
                    roomProperties,
                    inspectionLists
                }).length;
                const kb = (size / 1024).toFixed(1);
                dataSize.textContent = kb + 'KB';
            }
            
            // Update configured rooms count
            const configuredRooms = document.getElementById('configured-rooms-count');
            if (configuredRooms) {
                configuredRooms.textContent = Object.keys(roomProperties).length;
            }
            
            // Update inspector names
            const currentInspectors = document.getElementById('current-inspectors');
            if (currentInspectors) {
                currentInspectors.textContent = 'Current: ' + inspectorNames.join(', ');
            }
            
            // Update lists count
            const totalListsElem = document.getElementById('admin-total-lists');
            if (totalListsElem) {
                totalListsElem.textContent = inspectionLists.length;
            }
            
            const activeListElem = document.getElementById('admin-active-list');
            if (activeListElem) {
                if (activeListId) {
                    const list = inspectionLists.find(l => l.id === activeListId);
                    activeListElem.textContent = list ? list.name : 'None';
                } else {
                    activeListElem.textContent = 'None';
                }
            }
        }
        function logAdmin(msg) {
            const log = document.getElementById('admin-log');
            if (log) {
                const timestamp = new Date().toLocaleTimeString();
                log.innerHTML += `[${timestamp}] ${msg}<br>`;
                log.scrollTop = log.scrollHeight;
            }
        }

        async function forceDataSync() {
            if (!isConnected) {
                alert('Not connected to Firebase');
                return;
            }
            
            showLoading(true);
            try {
                await saveData();
                await loadData();
                logAdmin('‚úì Data synced successfully');
                alert('Data synced successfully!');
            } catch (error) {
                logAdmin('‚úó Sync failed: ' + error.message);
                alert('Sync failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        async function testFirebasePermissions() {
            if (!isConnected || !db) {
                alert('Firebase is not connected');
                logAdmin('‚úó Firebase not connected');
                return;
            }
            
            logAdmin('üîç Testing Firebase permissions...');
            showLoading(true);
            
            try {
                // Test write
                logAdmin('Testing WRITE permission...');
                await db.collection('dormData').doc('_test').set({
                    test: true,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                logAdmin('‚úì WRITE test passed');
                
                // Test read
                logAdmin('Testing READ permission...');
                const doc = await db.collection('dormData').doc('_test').get();
                if (doc.exists) {
                    logAdmin('‚úì READ test passed');
                } else {
                    logAdmin('‚ö†Ô∏è READ test: document not found');
                }
                
                // Test delete
                logAdmin('Testing DELETE permission...');
                await db.collection('dormData').doc('_test').delete();
                logAdmin('‚úì DELETE test passed');
                
                logAdmin('‚úÖ All permission tests passed!');
                alert('‚úÖ Firebase permissions are working correctly!\n\nAll read/write/delete operations succeeded.');
                
            } catch (error) {
                logAdmin('‚ùå Permission test FAILED: ' + error.code);
                logAdmin('Error: ' + error.message);
                
                let message = '‚ùå Firebase Permission Test Failed!\n\n';
                
                if (error.code === 'permission-denied') {
                    message += 'PERMISSION DENIED\n\n';
                    message += 'Your Firestore security rules are blocking access.\n\n';
                    message += 'To fix this:\n';
                    message += '1. Go to Firebase Console\n';
                    message += '2. Select your project\n';
                    message += '3. Go to Firestore Database\n';
                    message += '4. Click on "Rules" tab\n';
                    message += '5. Update your rules to allow read/write access\n\n';
                    message += 'Example rule for testing:\n';
                    message += 'allow read, write: if true;';
                } else {
                    message += 'Error: ' + error.message;
                }
                
                alert(message);
            } finally {
                showLoading(false);
            }
        }

        function exportAllData() {
            const data = {
                inspections,
                scheduledRooms,
                roomProperties,
                inspectionLists,
                activeListId,
                inspectorNames,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dorm-inspector-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            logAdmin('‚úì Data exported to JSON');
        }

        function importDataPrompt() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (confirm('This will replace all current data. Continue?')) {
                            inspections = data.inspections || [];
                            scheduledRooms = data.scheduledRooms || [];
                            roomProperties = data.roomProperties || {};
                            inspectionLists = data.inspectionLists || [];
                            activeListId = data.activeListId || null;
                            inspectorNames = data.inspectorNames || inspectorNames;
                            
                            await saveData();
                            updateAdminStats();
                            setupForm();
                            
                            logAdmin('‚úì Data imported successfully');
                            alert('Data imported successfully!');
                        }
                    } catch (error) {
                        logAdmin('‚úó Import failed: ' + error.message);
                        alert('Failed to import data: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        async function resetAllData() {
            const confirmation = prompt('Type "DELETE ALL" to confirm reset:');
            if (confirmation !== 'DELETE ALL') {
                alert('Reset cancelled');
                return;
            }
            
            if (confirm('Are you ABSOLUTELY SURE? This cannot be undone!')) {
                inspections = [];
                scheduledRooms = [];
                roomProperties = {};
                inspectionLists = [];
                activeListId = null;
                
                await saveData();
                updateAdminStats();
                setupForm();
                loadInspectionsList();
                
                logAdmin('‚ö† All data reset');
                alert('All data has been reset');
            }
        }

        function manageInspectors() {
            const current = inspectorNames.join(', ');
            const newNames = prompt('Enter inspector names (comma-separated):', current);
            
            if (newNames !== null) {
                inspectorNames = newNames.split(',').map(n => n.trim()).filter(n => n);
                saveData();
                updateInspectorDropdown();
                updateAdminStats();
                logAdmin('‚úì Inspector names updated');
            }
        }

        function resetInspectorNames() {
            if (confirm('Reset to default inspector names?')) {
                inspectorNames = ['Hoskins', 'Troope', 'Smith', 'Cherry', 'Avila', 'Young', 'Grier'];
                saveData();
                updateInspectorDropdown();
                updateAdminStats();
                logAdmin('‚úì Inspector names reset to defaults');
            }
        }

        function clearLocalStorage() {
            if (confirm('Clear local storage cache? (Firebase data will remain)')) {
                localStorage.removeItem('dormInspections');
                localStorage.removeItem('weeklySchedule');
                localStorage.removeItem('roomProperties');
                localStorage.removeItem('inspectionLists');
                localStorage.removeItem('activeListId');
                localStorage.removeItem('inspectorNames');
                logAdmin('‚úì Local storage cleared');
                alert('Local storage cleared');
            }
        }

        async function testFirebaseConnection() {
            if (!db) {
                logAdmin('‚úó Firebase not initialized');
                alert('Firebase not initialized');
                return;
            }
            
            showLoading(true);
            try {
                const testDoc = await db.collection('dormData').doc('inspections').get();
                if (testDoc.exists) {
                    logAdmin('‚úì Firebase connection successful');
                    alert('Firebase connection successful!');
                } else {
                    logAdmin('‚ö† Firebase connected but no data found');
                    alert('Firebase connected but no data found');
                }
            } catch (error) {
                logAdmin('‚úó Firebase connection failed: ' + error.message);
                alert('Connection failed: ' + error.message);
            } finally {
                showLoading(false);
            }
        }

        function generateTestData() {
            if (!confirm('Generate 10 random test inspections?')) return;
            
            for (let i = 0; i < 10; i++) {
                const roomNum = 201 + Math.floor(Math.random() * 99);
                const score = Math.floor(Math.random() * 6);
                const status = score === 0 ? 'OUTSTANDING' : score <= 3 ? 'PASSED' : 'FAILED';
                
                inspections.push({
                    id: Date.now() + i,
                    roomNumber: roomNum,
                    inspectionDate: new Date().toISOString().split('T')[0],
                    inspectorName: inspectorNames[Math.floor(Math.random() * inspectorNames.length)],
                    demerits: [],
                    autoFailureDemerits: [],
                    regularScore: score,
                    autoFailureScore: 0,
                    score: score,
                    status: status,
                    notes: 'Test data',
                    timestamp: new Date().toISOString()
                });
            }
            
            saveData();
            updateAdminStats();
            logAdmin('‚úì Generated 10 test inspections');
            alert('Test data generated!');
        }
        function generateInspectorAnalytics() {
            const filteredInspections = getFilteredInspections('analytics');
            
            if (filteredInspections.length === 0) {
                alert('No data available for selected date range');
                return;
            }
            
            const inspectorStats = {};
            filteredInspections.forEach(inspection => {
                const inspector = inspection.inspectorName || 'Unknown';
                if (!inspectorStats[inspector]) {
                    inspectorStats[inspector] = {
                        total: 0,
                        passed: 0,
                        failed: 0,
                        outstanding: 0,
                        totalScore: 0,
                        rooms: new Set()
                    };
                }
                
                const stats = inspectorStats[inspector];
                stats.total++;
                stats.totalScore += inspection.score;
                stats.rooms.add(inspection.roomNumber);
                
                if (inspection.status === 'OUTSTANDING') {
                    stats.outstanding++;
                } else if (inspection.status === 'PASSED') {
                    stats.passed++;
                } else {
                    stats.failed++;
                }
            });
            
            let html = '<h4 style="margin-bottom: 16px;">Inspector Performance Analysis</h4>';
            html += '<div style="display: grid; gap: 12px;">';
            
            Object.keys(inspectorStats).sort((a, b) => inspectorStats[b].total - inspectorStats[a].total).forEach(inspector => {
                const stats = inspectorStats[inspector];
                const avgScore = (stats.totalScore / stats.total).toFixed(1);
                const failureRate = ((stats.failed / stats.total) * 100).toFixed(1);
                
                html += `
                    <div style="padding: 16px; background: var(--surface); border-radius: 12px; border: 2px solid var(--border);">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">${inspector}</div>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 13px;">
                            <div>Total: <strong>${stats.total}</strong></div>
                            <div>Avg Score: <strong>${avgScore}</strong></div>
                            <div>Outstanding: <strong style="color: #3b82f6;">${stats.outstanding}</strong></div>
                            <div>Passed: <strong style="color: var(--success);">${stats.passed}</strong></div>
                            <div>Failed: <strong style="color: var(--error);">${stats.failed}</strong></div>
                            <div>Failure Rate: <strong>${failureRate}%</strong></div>
                            <div>Unique Rooms: <strong>${stats.rooms.size}</strong></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            const display = document.getElementById('analytics-display');
            display.style.display = 'block';
            document.getElementById('analytics-content').innerHTML = html;
            
            logAdmin('‚úì Inspector analytics generated');
        }

        function generateDemeritTrends() {
            const filteredInspections = getFilteredInspections('analytics');
            
            if (filteredInspections.length === 0) {
                alert('No data available for selected date range');
                return;
            }
            
            const demeritCounts = {};
            const autoFailCounts = {};
            
            filteredInspections.forEach(inspection => {
                if (inspection.demerits) {
                    inspection.demerits.forEach(d => {
                        demeritCounts[d] = (demeritCounts[d] || 0) + 1;
                    });
                }
                if (inspection.autoFailureDemerits) {
                    inspection.autoFailureDemerits.forEach(d => {
                        autoFailCounts[d] = (autoFailCounts[d] || 0) + 1;
                    });
                }
            });
            
            let html = '<h4 style="margin-bottom: 16px;">Violation Trends</h4>';
            
            if (Object.keys(autoFailCounts).length > 0) {
                html += '<div style="margin-bottom: 20px;"><h5 style="color: var(--error); margin-bottom: 12px;">Auto-Failure Violations</h5>';
                html += '<div style="display: grid; gap: 8px;">';
                Object.entries(autoFailCounts).sort((a, b) => b[1] - a[1]).forEach(([demerit, count]) => {
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; border-left: 4px solid var(--error);">
                            <span>${demerit}</span>
                            <strong>${count}</strong>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            if (Object.keys(demeritCounts).length > 0) {
                html += '<div><h5 style="color: var(--primary); margin-bottom: 12px;">Regular Violations</h5>';
                html += '<div style="display: grid; gap: 8px;">';
                Object.entries(demeritCounts).sort((a, b) => b[1] - a[1]).forEach(([demerit, count]) => {
                    html += `
                        <div style="display: flex; justify-content: space-between; padding: 12px; background: var(--surface); border-radius: 8px; border-left: 4px solid var(--primary);">
                            <span>${demerit}</span>
                            <strong>${count}</strong>
                        </div>
                    `;
                });
                html += '</div></div>';
            }
            
            const display = document.getElementById('analytics-display');
            display.style.display = 'block';
            document.getElementById('analytics-content').innerHTML = html;
            
            logAdmin('‚úì Violation trends generated');
        }

        function generateTimelineReport() {
            const filteredInspections = getFilteredInspections('analytics');
            
            if (filteredInspections.length === 0) {
                alert('No data available for selected date range');
                return;
            }
            
            const dateGroups = {};
            filteredInspections.forEach(inspection => {
                const date = inspection.inspectionDate;
                if (!dateGroups[date]) {
                    dateGroups[date] = {
                        total: 0,
                        outstanding: 0,
                        passed: 0,
                        failed: 0,
                        totalScore: 0
                    };
                }
                
                const group = dateGroups[date];
                group.total++;
                group.totalScore += inspection.score;
                
                if (inspection.status === 'OUTSTANDING') group.outstanding++;
                else if (inspection.status === 'PASSED') group.passed++;
                else group.failed++;
            });
            
            let html = '<h4 style="margin-bottom: 16px;">Timeline Report</h4>';
            html += '<div style="display: grid; gap: 12px;">';
            
            Object.keys(dateGroups).sort().reverse().forEach(date => {
                const group = dateGroups[date];
                const avgScore = (group.totalScore / group.total).toFixed(1);
                const passRate = (((group.outstanding + group.passed) / group.total) * 100).toFixed(1);
                
                html += `
                    <div style="padding: 16px; background: var(--surface); border-radius: 12px; border: 2px solid var(--border);">
                        <div style="font-weight: 700; font-size: 16px; margin-bottom: 8px;">${new Date(date).toLocaleDateString()}</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 13px;">
                            <div>Total: <strong>${group.total}</strong></div>
                            <div>Avg Score: <strong>${avgScore}</strong></div>
                            <div>Pass Rate: <strong>${passRate}%</strong></div>
                            <div style="color: #3b82f6;">Outstanding: <strong>${group.outstanding}</strong></div>
                            <div style="color: var(--success);">Passed: <strong>${group.passed}</strong></div>
                            <div style="color: var(--error);">Failed: <strong>${group.failed}</strong></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            const display = document.getElementById('analytics-display');
            display.style.display = 'block';
            document.getElementById('analytics-content').innerHTML = html;
            
            logAdmin('‚úì Timeline report generated');
        }

        function closeAnalytics() {
            document.getElementById('analytics-display').style.display = 'none';
        }
        function openRoomManagement() {
            document.getElementById('room-management-modal').classList.add('show');
            
            const select = document.getElementById('room-edit-select');
            select.innerHTML = '<option value="">Choose a room to edit</option>';
            
            for (let i = 201; i <= 299; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Room ${i}`;
                select.appendChild(option);
            }
            for (let i = 301; i <= 399; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Room ${i}`;
                select.appendChild(option);
            }
        }

        function closeRoomManagement() {
            document.getElementById('room-management-modal').classList.remove('show');
        }

        function loadRoomProperties() {
            const roomNumber = document.getElementById('room-edit-select').value;
            const form = document.getElementById('room-edit-form');
            
            if (!roomNumber) {
                form.style.display = 'none';
                return;
            }
            
            form.style.display = 'block';
            
            const props = roomProperties[roomNumber] || {};
            
            // Reset buttons
            document.querySelectorAll('.shift-btn').forEach(btn => {
                btn.style.background = 'var(--surface-light)';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'var(--text-primary)';
            });
            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.style.background = 'var(--surface-light)';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'var(--text-primary)';
            });
            
            // Set current values
            if (props.shift) {
                const shiftBtn = document.querySelector(`.shift-btn[data-shift="${props.shift}"]`);
                if (shiftBtn) {
                    shiftBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
                    shiftBtn.style.borderColor = 'transparent';
                    shiftBtn.style.color = 'white';
                }
            }
            
            if (props.gender) {
                const genderBtn = document.querySelector(`.gender-btn[data-gender="${props.gender}"]`);
                if (genderBtn) {
                    genderBtn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
                    genderBtn.style.borderColor = 'transparent';
                    genderBtn.style.color = 'white';
                }
            }
        }

        var selectedShift = null;
        var selectedGender = null;

        function selectShift(shift) {
            selectedShift = shift;
            
            document.querySelectorAll('.shift-btn').forEach(btn => {
                btn.style.background = 'var(--surface-light)';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'var(--text-primary)';
            });
            
            const btn = document.querySelector(`.shift-btn[data-shift="${shift}"]`);
            if (btn) {
                btn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
                btn.style.borderColor = 'transparent';
                btn.style.color = 'white';
            }
        }

        function selectGender(gender) {
            selectedGender = gender;
            
            document.querySelectorAll('.gender-btn').forEach(btn => {
                btn.style.background = 'var(--surface-light)';
                btn.style.borderColor = 'var(--border)';
                btn.style.color = 'var(--text-primary)';
            });
            
            const btn = document.querySelector(`.gender-btn[data-gender="${gender}"]`);
            if (btn) {
                btn.style.background = 'linear-gradient(135deg, var(--primary), var(--secondary))';
                btn.style.borderColor = 'transparent';
                btn.style.color = 'white';
            }
        }

        async function saveRoomProperties() {
            const roomNumber = document.getElementById('room-edit-select').value;
            
            if (!roomNumber) {
                alert('Please select a room');
                return;
            }
            
            if (!selectedShift && !selectedGender) {
                alert('Please select at least shift or gender');
                return;
            }
            
            if (!roomProperties[roomNumber]) {
                roomProperties[roomNumber] = {};
            }
            
            if (selectedShift) {
                roomProperties[roomNumber].shift = selectedShift;
            }
            if (selectedGender) {
                roomProperties[roomNumber].gender = selectedGender;
            }
            
            await saveData();
            setupRoomTiles();
            updateScheduledRoomsDisplay();
            
            alert(`Room ${roomNumber} properties saved!`);
            logAdmin(`‚úì Room ${roomNumber} properties updated`);
            
            selectedShift = null;
            selectedGender = null;
            closeRoomManagement();
        }

        async function bulkSetRoomProperties() {
            const ranges = prompt('Enter room ranges (e.g., "201-250, 301-320"):');
            if (!ranges) return;
            
            const shift = prompt('Enter shift (S, T, or R):');
            if (!shift || !['S', 'T', 'R'].includes(shift.toUpperCase())) {
                alert('Invalid shift');
                return;
            }
            
            const gender = prompt('Enter gender (Male or Female):');
            if (!gender || !['Male', 'Female'].includes(gender)) {
                alert('Invalid gender');
                return;
            }
            
            const rangeParts = ranges.split(',');
            let count = 0;
            
            rangeParts.forEach(part => {
                const [start, end] = part.trim().split('-').map(n => parseInt(n));
                
                if (start && end) {
                    for (let i = start; i <= end; i++) {
                        if (!roomProperties[i]) {
                            roomProperties[i] = {};
                        }
                        roomProperties[i].shift = shift.toUpperCase();
                        roomProperties[i].gender = gender;
                        count++;
                    }
                }
            });
            
            await saveData();
            setupRoomTiles();
            updateScheduledRoomsDisplay();
            updateAdminStats();
            
            alert(`Properties set for ${count} rooms!`);
            logAdmin(`‚úì Bulk properties set for ${count} rooms`);
        }
        function openListManagement() {
            document.getElementById('list-management-modal').classList.add('show');
            updateListsDisplay();
        }

        function closeListManagement() {
            document.getElementById('list-management-modal').classList.remove('show');
        }

        function updateListsDisplay() {
            const container = document.getElementById('lists-container');
            
            if (inspectionLists.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">No lists created yet</p>';
                return;
            }
            
            container.innerHTML = inspectionLists.map(list => {
                const isActive = list.id === activeListId;
                return `
                    <div style="padding: 16px; background: var(--surface-light); border: 2px solid ${isActive ? 'var(--primary)' : 'var(--border)'}; border-radius: 12px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <div>
                                <div style="font-weight: 700; font-size: 16px;">${list.name}</div>
                                <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${list.rooms.length} rooms</div>
                            </div>
                            ${isActive ? '<span style="padding: 4px 12px; background: var(--primary); color: white; border-radius: 20px; font-size: 11px; font-weight: 700;">ACTIVE</span>' : ''}
                        </div>
                        <div style="display: flex; gap: 8px;">
                            ${!isActive ? `<button onclick="setActiveList('${list.id}')" class="btn btn-primary btn-small" style="flex: 1;">Set Active</button>` : '<button class="btn btn-secondary btn-small" style="flex: 1;" disabled>Active</button>'}
                            <button onclick="renameList('${list.id}')" class="btn btn-secondary btn-small">‚úèÔ∏è Rename</button>
                            <button onclick="deleteList('${list.id}')" class="btn btn-danger btn-small">üóëÔ∏è</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function createNewList() {
            const name = prompt('Enter list name (e.g., "Week 1", "S-Shift Monday"):');
            
            if (!name || !name.trim()) {
                return;
            }
            
            const newList = {
                id: 'list_' + Date.now(),
                name: name.trim(),
                rooms: [],
                createdAt: new Date().toISOString()
            };
            
            inspectionLists.push(newList);
            
            // Set as active if it's the first list
            if (inspectionLists.length === 1) {
                activeListId = newList.id;
            }
            
            saveData();
            updateListsDisplay();
            updateActiveListSelect();
            updateInspectionListSelect();
            updateAdminStats();
            
            logAdmin(`‚úì Created list: ${name}`);
            alert(`List "${name}" created!`);
        }

        function renameList(listId) {
            const list = inspectionLists.find(l => l.id === listId);
            if (!list) return;
            
            const newName = prompt('Enter new name:', list.name);
            if (!newName || !newName.trim()) return;
            
            list.name = newName.trim();
            saveData();
            updateListsDisplay();
            updateActiveListSelect();
            updateInspectionListSelect();
            
            logAdmin(`‚úì Renamed list to: ${newName}`);
        }

        async function deleteList(listId) {
            const list = inspectionLists.find(l => l.id === listId);
            if (!list) return;
            
            if (!confirm(`Delete list "${list.name}"? This cannot be undone.`)) return;
            
            const index = inspectionLists.findIndex(l => l.id === listId);
            inspectionLists.splice(index, 1);
            
            // If deleted list was active, clear active list
            if (activeListId === listId) {
                activeListId = null;
            }
            
            await saveData();
            updateListsDisplay();
            updateActiveListSelect();
            updateInspectionListSelect();
            updateScheduledRoomsDisplay();
            updateRoomDropdown();
            updateAdminStats();
            
            logAdmin(`‚úì Deleted list: ${list.name}`);
        }

        async function setActiveList(listId) {
            activeListId = listId;
            await saveData();
            updateListsDisplay();
            updateActiveListSelect();
            updateInspectionListSelect();
            updateScheduledRoomsDisplay();
            updateRoomDropdown();
            updateAdminStats();
            
            const list = inspectionLists.find(l => l.id === listId);
            if (list) {
                logAdmin(`‚úì Set active list: ${list.name}`);
            }
        }

        function updateActiveListSelect() {
            const select = document.getElementById('active-list-select');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">No list selected</option>';
            
            inspectionLists.forEach(list => {
                const option = document.createElement('option');
                option.value = list.id;
                option.textContent = `${list.name} (${list.rooms.length} rooms)`;
                select.appendChild(option);
            });
            
            if (activeListId) {
                select.value = activeListId;
            } else if (currentValue) {
                select.value = currentValue;
            }
            
            updateActiveListInfo();
        }

        function updateInspectionListSelect() {
            const select = document.getElementById('inspection-list-select');
            if (!select) return;
            
            const currentValue = select.value;
            select.innerHTML = '<option value="">All Rooms from All Lists</option>';
            
            inspectionLists.forEach(list => {
                const option = document.createElement('option');
                option.value = list.id;
                option.textContent = `${list.name} (${list.rooms.length} rooms)`;
                select.appendChild(option);
            });
            
            if (currentValue) {
                select.value = currentValue;
            }
        }

        function updateActiveListInfo() {
            const info = document.getElementById('active-list-info');
            if (!info) return;
            
            if (activeListId) {
                const list = inspectionLists.find(l => l.id === activeListId);
                if (list) {
                    info.textContent = `${list.rooms.length} rooms in this list`;
                    info.style.color = 'var(--text-secondary)';
                }
            } else {
                info.textContent = 'Select a list to work with';
                info.style.color = 'var(--text-muted)';
            }
        }

        async function switchActiveList() {
            const select = document.getElementById('active-list-select');
            activeListId = select.value || null;
            await saveData();
            updateScheduledRoomsDisplay();
            updateRoomDropdown();
            updateActiveListInfo();
            updateAdminStats();
        }

        function changeInspectionList() {
            updateRoomDropdown();
        }

        function getActiveListRooms() {
            if (!activeListId) return [];
            const list = inspectionLists.find(l => l.id === activeListId);
            return list ? list.rooms : [];
        }

        function getInspectionListRooms() {
            const select = document.getElementById('inspection-list-select');
            const selectedListId = select ? select.value : '';
            
            if (!selectedListId) {
                // Return all rooms from all lists
                const allRooms = new Set();
                inspectionLists.forEach(list => {
                    list.rooms.forEach(room => allRooms.add(room));
                });
                return Array.from(allRooms).sort((a, b) => parseInt(a) - parseInt(b));
            }
            
            const list = inspectionLists.find(l => l.id === selectedListId);
            return list ? list.rooms.slice().sort((a, b) => parseInt(a) - parseInt(b)) : [];
        }

        async function addSelectedRoomsToActiveList() {
            if (!activeListId) {
                alert('Please select an active list first');
                return;
            }
            
            if (selectedRoomTiles.size === 0) {
                alert('Please select at least one room');
                return;
            }
            
            const list = inspectionLists.find(l => l.id === activeListId);
            if (!list) return;
            
            let added = 0;
            selectedRoomTiles.forEach(roomNumber => {
                if (!list.rooms.includes(roomNumber)) {
                    list.rooms.push(roomNumber);
                    added++;
                }
            });
            
            list.rooms.sort((a, b) => parseInt(a) - parseInt(b));
            
            await saveData();
            clearAllSelectedRooms();
            updateScheduledRoomsDisplay();
            updateRoomDropdown();
            updateActiveListSelect();
            updateInspectionListSelect();
            updateAdminStats();
            
            alert(`Added ${added} room(s) to "${list.name}"`);
            logAdmin(`‚úì Added ${added} rooms to ${list.name}`);
        }

        async function clearActiveList() {
            if (!activeListId) return;
            
            const list = inspectionLists.find(l => l.id === activeListId);
            if (!list) return;
            
            if (!confirm(`Clear all rooms from "${list.name}"?`)) return;
            
            list.rooms = [];
            await saveData();
            updateScheduledRoomsDisplay();
            updateRoomDropdown();
            updateActiveListSelect();
            updateInspectionListSelect();
            updateAdminStats();
            
            logAdmin(`‚úì Cleared list: ${list.name}`);
        }
    </script>
</body>
</html>
